<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模块化 | Yolanda</title>
    <meta name="description" content="每天学习一点点">
    <link rel="icon" href="/Notebook/images/mylogo.jpg">
    
    <link rel="preload" href="/Notebook/assets/css/0.styles.4f932b82.css" as="style"><link rel="preload" href="/Notebook/assets/js/app.fae3116e.js" as="script"><link rel="preload" href="/Notebook/assets/js/3.8a90166b.js" as="script"><link rel="preload" href="/Notebook/assets/js/15.edab26a3.js" as="script"><link rel="prefetch" href="/Notebook/assets/js/10.7c0500f6.js"><link rel="prefetch" href="/Notebook/assets/js/11.96ce6645.js"><link rel="prefetch" href="/Notebook/assets/js/12.295d52cd.js"><link rel="prefetch" href="/Notebook/assets/js/13.6db71019.js"><link rel="prefetch" href="/Notebook/assets/js/14.0c1400d8.js"><link rel="prefetch" href="/Notebook/assets/js/16.88fd161d.js"><link rel="prefetch" href="/Notebook/assets/js/17.408350d5.js"><link rel="prefetch" href="/Notebook/assets/js/18.6ab68d1c.js"><link rel="prefetch" href="/Notebook/assets/js/19.9e9ef1da.js"><link rel="prefetch" href="/Notebook/assets/js/2.e3a9cac0.js"><link rel="prefetch" href="/Notebook/assets/js/20.56c42c66.js"><link rel="prefetch" href="/Notebook/assets/js/21.8d087c07.js"><link rel="prefetch" href="/Notebook/assets/js/22.cf2b0a03.js"><link rel="prefetch" href="/Notebook/assets/js/23.7413880a.js"><link rel="prefetch" href="/Notebook/assets/js/24.28bab990.js"><link rel="prefetch" href="/Notebook/assets/js/25.75c60686.js"><link rel="prefetch" href="/Notebook/assets/js/26.ef1edf61.js"><link rel="prefetch" href="/Notebook/assets/js/27.5aeea7cc.js"><link rel="prefetch" href="/Notebook/assets/js/28.8476b7e4.js"><link rel="prefetch" href="/Notebook/assets/js/29.956345a3.js"><link rel="prefetch" href="/Notebook/assets/js/30.b96e226e.js"><link rel="prefetch" href="/Notebook/assets/js/31.04440a69.js"><link rel="prefetch" href="/Notebook/assets/js/32.273112ca.js"><link rel="prefetch" href="/Notebook/assets/js/33.e709b2b3.js"><link rel="prefetch" href="/Notebook/assets/js/34.dc2136ae.js"><link rel="prefetch" href="/Notebook/assets/js/35.30ab0118.js"><link rel="prefetch" href="/Notebook/assets/js/36.cb41bc4a.js"><link rel="prefetch" href="/Notebook/assets/js/37.dd26a76e.js"><link rel="prefetch" href="/Notebook/assets/js/38.68398169.js"><link rel="prefetch" href="/Notebook/assets/js/39.93b8990e.js"><link rel="prefetch" href="/Notebook/assets/js/4.5f27db7e.js"><link rel="prefetch" href="/Notebook/assets/js/40.ed267aa9.js"><link rel="prefetch" href="/Notebook/assets/js/41.985eec03.js"><link rel="prefetch" href="/Notebook/assets/js/42.260a858d.js"><link rel="prefetch" href="/Notebook/assets/js/43.6cb97df7.js"><link rel="prefetch" href="/Notebook/assets/js/44.869ede03.js"><link rel="prefetch" href="/Notebook/assets/js/45.bf3e5a26.js"><link rel="prefetch" href="/Notebook/assets/js/46.a54b425c.js"><link rel="prefetch" href="/Notebook/assets/js/47.8ebe066b.js"><link rel="prefetch" href="/Notebook/assets/js/48.416ad307.js"><link rel="prefetch" href="/Notebook/assets/js/49.7394cd78.js"><link rel="prefetch" href="/Notebook/assets/js/5.01244a1f.js"><link rel="prefetch" href="/Notebook/assets/js/50.4675f4c4.js"><link rel="prefetch" href="/Notebook/assets/js/51.a112471f.js"><link rel="prefetch" href="/Notebook/assets/js/52.a6195fbf.js"><link rel="prefetch" href="/Notebook/assets/js/53.15f5f0a8.js"><link rel="prefetch" href="/Notebook/assets/js/54.bbc6eb3c.js"><link rel="prefetch" href="/Notebook/assets/js/55.ba5d1f28.js"><link rel="prefetch" href="/Notebook/assets/js/56.2d5a7c0d.js"><link rel="prefetch" href="/Notebook/assets/js/57.b6f47637.js"><link rel="prefetch" href="/Notebook/assets/js/58.3ce0f8ce.js"><link rel="prefetch" href="/Notebook/assets/js/59.66784ebf.js"><link rel="prefetch" href="/Notebook/assets/js/6.4d03de1b.js"><link rel="prefetch" href="/Notebook/assets/js/60.2c355106.js"><link rel="prefetch" href="/Notebook/assets/js/61.1fb23164.js"><link rel="prefetch" href="/Notebook/assets/js/62.5ee4cd1c.js"><link rel="prefetch" href="/Notebook/assets/js/63.08a71f63.js"><link rel="prefetch" href="/Notebook/assets/js/64.e7464a6a.js"><link rel="prefetch" href="/Notebook/assets/js/65.de9108af.js"><link rel="prefetch" href="/Notebook/assets/js/66.83e75f1b.js"><link rel="prefetch" href="/Notebook/assets/js/67.3caaf58d.js"><link rel="prefetch" href="/Notebook/assets/js/68.2dd69095.js"><link rel="prefetch" href="/Notebook/assets/js/69.927efe78.js"><link rel="prefetch" href="/Notebook/assets/js/7.a97cfeeb.js"><link rel="prefetch" href="/Notebook/assets/js/70.92fd8264.js"><link rel="prefetch" href="/Notebook/assets/js/71.0ef73e07.js"><link rel="prefetch" href="/Notebook/assets/js/72.7e0a2fee.js"><link rel="prefetch" href="/Notebook/assets/js/73.816bc4b8.js"><link rel="prefetch" href="/Notebook/assets/js/74.e1c44e90.js"><link rel="prefetch" href="/Notebook/assets/js/75.52d5991e.js"><link rel="prefetch" href="/Notebook/assets/js/76.3ab263b9.js"><link rel="prefetch" href="/Notebook/assets/js/77.76e6e752.js"><link rel="prefetch" href="/Notebook/assets/js/78.e2711be8.js"><link rel="prefetch" href="/Notebook/assets/js/79.ecf0c259.js"><link rel="prefetch" href="/Notebook/assets/js/8.698b291a.js"><link rel="prefetch" href="/Notebook/assets/js/80.6defbc57.js"><link rel="prefetch" href="/Notebook/assets/js/81.650b6435.js"><link rel="prefetch" href="/Notebook/assets/js/82.f41e2c82.js"><link rel="prefetch" href="/Notebook/assets/js/83.62a3d0ce.js"><link rel="prefetch" href="/Notebook/assets/js/84.f2e0ba7a.js"><link rel="prefetch" href="/Notebook/assets/js/85.7d5af1cd.js"><link rel="prefetch" href="/Notebook/assets/js/86.883b02f7.js"><link rel="prefetch" href="/Notebook/assets/js/87.dc5913fb.js"><link rel="prefetch" href="/Notebook/assets/js/88.369e5f01.js"><link rel="prefetch" href="/Notebook/assets/js/89.fd496723.js"><link rel="prefetch" href="/Notebook/assets/js/9.220abfab.js"><link rel="prefetch" href="/Notebook/assets/js/90.1d16c82f.js"><link rel="prefetch" href="/Notebook/assets/js/91.6bcdcb57.js"><link rel="prefetch" href="/Notebook/assets/js/92.3f6beaea.js"><link rel="prefetch" href="/Notebook/assets/js/93.d98ca184.js">
    <link rel="stylesheet" href="/Notebook/assets/css/0.styles.4f932b82.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Notebook/" class="home-link router-link-active"><!----> <span class="site-name">Yolanda</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Notebook/dailyRecord/" class="nav-link">📝日常记录</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发者</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/frontend-web/" class="nav-link router-link-active">💻大前端</a></li><li class="dropdown-item"><!----> <a href="/Notebook/rethink/" class="nav-link">🤔复盘</a></li><li class="dropdown-item"><h4>️️🧘算法修炼</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notebook/algorithm/computerBasics.html" class="nav-link">计算机基础</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/dataStructure.html" class="nav-link">数据结构</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/algorithm.html" class="nav-link">算法分类</a></li><li class="dropdown-subitem"><a href="/Notebook/dataBase/index.html" class="nav-link">数据库</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Notebook/devops/" class="nav-link">☁️运维</a></li><li class="dropdown-item"><!----> <a href="/Notebook/test/" class="nav-link">🚬测试</a></li><li class="dropdown-item"><!----> <a href="/Notebook/gis/" class="nav-link">🌍GIS</a></li><li class="dropdown-item"><!----> <a href="/Notebook/software/" class="nav-link">️️🖱️软件</a></li><li class="dropdown-item"><!----> <a href="/Notebook/network/" class="nav-link">️️🐛网络工程</a></li><li class="dropdown-item"><!----> <a href="/Notebook/csharp/" class="nav-link">🚗C#</a></li><li class="dropdown-item"><!----> <a href="/Notebook/unity/" class="nav-link">🎮Unity</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">设计</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/design/" class="nav-link">🖌️UI</a></li></ul></div></div><div class="nav-item"><a href="/Notebook/bookmark/" class="nav-link">🏷书签整理</a></div><div class="nav-item"><a href="/Notebook/lint/" class="nav-link">✔️编码规范&amp;协同开发</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  📖知识脑图
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://jecyu.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  🔧个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🔗Github</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Yolanda177" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Yolanda github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/language-learning/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英语学习
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/Fe-Auto-Testing/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端自动化测试
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Notebook/dailyRecord/" class="nav-link">📝日常记录</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发者</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/frontend-web/" class="nav-link router-link-active">💻大前端</a></li><li class="dropdown-item"><!----> <a href="/Notebook/rethink/" class="nav-link">🤔复盘</a></li><li class="dropdown-item"><h4>️️🧘算法修炼</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notebook/algorithm/computerBasics.html" class="nav-link">计算机基础</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/dataStructure.html" class="nav-link">数据结构</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/algorithm.html" class="nav-link">算法分类</a></li><li class="dropdown-subitem"><a href="/Notebook/dataBase/index.html" class="nav-link">数据库</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Notebook/devops/" class="nav-link">☁️运维</a></li><li class="dropdown-item"><!----> <a href="/Notebook/test/" class="nav-link">🚬测试</a></li><li class="dropdown-item"><!----> <a href="/Notebook/gis/" class="nav-link">🌍GIS</a></li><li class="dropdown-item"><!----> <a href="/Notebook/software/" class="nav-link">️️🖱️软件</a></li><li class="dropdown-item"><!----> <a href="/Notebook/network/" class="nav-link">️️🐛网络工程</a></li><li class="dropdown-item"><!----> <a href="/Notebook/csharp/" class="nav-link">🚗C#</a></li><li class="dropdown-item"><!----> <a href="/Notebook/unity/" class="nav-link">🎮Unity</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">设计</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/design/" class="nav-link">🖌️UI</a></li></ul></div></div><div class="nav-item"><a href="/Notebook/bookmark/" class="nav-link">🏷书签整理</a></div><div class="nav-item"><a href="/Notebook/lint/" class="nav-link">✔️编码规范&amp;协同开发</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  📖知识脑图
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://jecyu.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  🔧个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🔗Github</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Yolanda177" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Yolanda github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/language-learning/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英语学习
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/Fe-Auto-Testing/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端自动化测试
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Notebook/frontend-web/browser.html" class="sidebar-link">浏览器</a></li><li><a href="/Notebook/frontend-web/css.html" class="sidebar-link">CSS</a></li><li><a href="/Notebook/frontend-web/javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/Notebook/frontend-web/es6.html" class="sidebar-link">ES6</a></li><li><a href="/Notebook/frontend-web/react.html" class="sidebar-link">React</a></li><li><a href="/Notebook/frontend-web/vue.html" class="sidebar-link">Vue</a></li><li><a href="/Notebook/frontend-web/webpack.html" class="sidebar-link">webpack</a></li><li><a href="/Notebook/frontend-web/" class="sidebar-link">工程化</a></li><li><a href="/Notebook/frontend-web/modulization.html" class="active sidebar-link">模块化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#什么是模块化？" class="sidebar-link">什么是模块化？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#没有模块化的编程" class="sidebar-link">没有模块化的编程</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#模块化的进展" class="sidebar-link">模块化的进展</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#模块化规范有哪几种？" class="sidebar-link">模块化规范有哪几种？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#commonjs" class="sidebar-link">CommonJS</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#amd" class="sidebar-link">AMD</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#cmd" class="sidebar-link">CMD</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#umd" class="sidebar-link">UMD</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#es6module" class="sidebar-link">ES6Module</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#模块化是如何实现的？" class="sidebar-link">模块化是如何实现的？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#module-prototype-require" class="sidebar-link">Module.prototype.require</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#module-load" class="sidebar-link">Module._load</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#module-prototype-load" class="sidebar-link">Module.prototype.load</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#module-prototype-compile" class="sidebar-link">Module.prototype._compile</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#模块实现总结" class="sidebar-link">模块实现总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#参考资料" class="sidebar-link">参考资料</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/modulization.html#手写req-方法（补充）" class="sidebar-link">手写req 方法（补充）</a></li></ul></li><li><a href="/Notebook/frontend-web/architecture.html" class="sidebar-link">架构</a></li><li><a href="/Notebook/frontend-web/authentication.html" class="sidebar-link">鉴权&amp;&amp;认证</a></li><li><a href="/Notebook/frontend-web/chrome.html" class="sidebar-link">chrome 调试技巧</a></li><li><a href="/Notebook/frontend-web/noJQ.html" class="sidebar-link">You (Might) Don't Need jQuery</a></li><li><a href="/Notebook/frontend-web/performance.html" class="sidebar-link">性能优化</a></li><li><a href="/Notebook/frontend-web/npm.html" class="sidebar-link">npm</a></li><li><a href="/Notebook/frontend-web/lodash.html" class="sidebar-link">lodash 源码分析及思路学习</a></li><li><a href="/Notebook/frontend-web/babel.html" class="sidebar-link">Babel</a></li><li><a href="/Notebook/frontend-web/rollup.html" class="sidebar-link">rollup</a></li><li><a href="/Notebook/frontend-web/docker.html" class="sidebar-link">Docker</a></li><li><a href="/Notebook/frontend-web/security.html" class="sidebar-link">前端安全</a></li><li><a href="/Notebook/frontend-web/file.html" class="sidebar-link">文件处理</a></li><li><a href="/Notebook/frontend-web/interview.html" class="sidebar-link">常见问题 1</a></li><li><a href="/Notebook/frontend-web/interview2.html" class="sidebar-link">常见问题 2</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="模块化"><a href="#模块化" aria-hidden="true" class="header-anchor">#</a> 模块化</h1> <h2 id="什么是模块化？"><a href="#什么是模块化？" aria-hidden="true" class="header-anchor">#</a> 什么是模块化？</h2> <ul><li>将一个复杂的程序依据一定的规则(规范)封装成几个块(文件), 并进行组合在一起</li> <li>块的内部数据与实现是私有的, 只是向外部暴露一些接口(方法)与外部其它模块通信</li></ul> <p>不仅前端有模块化，后端也有模块化</p> <p>在开发中较为流行的JavaScript模块规范有：CommonJS、AMD、CMD、UMD和ES6</p> <p><strong>为什么服务端需要模块化？</strong></p> <p>因为服务端需要与操作系统的其他应用程序互动，如果没有模块化是很难编程的</p> <p><strong>为什么客户端需要模块化？</strong></p> <p>在 JavaScript 发展初期，前端的大部分工作只是实现简单的交互逻辑，随着前端技术的发展，很多只在服务端实现的功能迁移到客户端实现，而嵌入网页的JS代码越来越庞大、复杂，模块化编程成为了一个迫切的需求</p> <p>（在没有模块化编程时，我们会遇到以下几点问题：)</p> <h3 id="没有模块化的编程"><a href="#没有模块化的编程" aria-hidden="true" class="header-anchor">#</a> 没有模块化的编程</h3> <ul><li>程序的变量和方法不容易维护，容易污染全局变量</li> <li>加载资源的方式主要是通过 <strong>script</strong> 标签从上到下，页面白屏时间过长，客户体验感较差</li> <li>依赖的环境主观逻辑偏重，代码一旦多了就比较复杂</li> <li>大型项目资源难以维护，在多人合作的情况下，资源的引入容易让人奔溃</li></ul> <p>刚开始时，我们是这样为页面引入资源：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;../js/lib/lodash.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;../js/lib/jquery.min.js&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/vue&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://unpkg.com/axios/dist/axios.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>script 标签<strong>从上到下</strong>引入了我们想要的资源，这其中的顺序是非常重要的，资源的加载先后决定了我们的代码是否能够跑下去。当然在前面我们了解到 script 新增有 defer 和 async 属性，但这里暂时不讨论这两者的作用。可以看出，当我们项目越大，依赖越多时，就会有更多的 script 标签，相应也有越多的资源请求。这时全局污染的可能性会更大，如何能避免上述的几个问题，形成独立的作用域，各程序间互不干扰呢？</p> <h3 id="模块化的进展"><a href="#模块化的进展" aria-hidden="true" class="header-anchor">#</a> 模块化的进展</h3> <p><strong>直接定义依赖 模式:</strong> 直接将变量定义在全局</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// greeting.js</span>
<span class="token keyword">var</span> helloInLang <span class="token operator">=</span> <span class="token punctuation">{</span>
  en<span class="token punctuation">:</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">,</span>
  es<span class="token punctuation">:</span> <span class="token string">&quot;Hola mundo!&quot;</span><span class="token punctuation">,</span>
  cn<span class="token punctuation">:</span> <span class="token string">&quot;你好 世界!&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">writeHello</span><span class="token punctuation">(</span><span class="token parameter">lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  dounment<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>helloInLang<span class="token punctuation">[</span>lang<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// other.js</span>
<span class="token keyword">function</span> <span class="token function">writeHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  dounment<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;another same function broken&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// index.html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./greeting.hjs&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./other.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body onLoad<span class="token operator">=</span><span class="token string">&quot;writeHello('cn')&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre></div><p>（这种就是典型的全局变量被污染的现象，于是有人提出<em>命名空间模式</em>，用于解决遍地全局变量）</p> <p><strong>命名空间 模式:</strong> 将需要定义的部分归属到一个对象的属性上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// greeting.js</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
app<span class="token punctuation">.</span>helloInLang <span class="token operator">=</span> <span class="token punctuation">{</span>
  en<span class="token punctuation">:</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">,</span>
  es<span class="token punctuation">:</span> <span class="token string">&quot;Hola mundo!&quot;</span><span class="token punctuation">,</span>
  cn<span class="token punctuation">:</span> <span class="token string">&quot;你好 世界!&quot;</span>
<span class="token punctuation">}</span>
app<span class="token punctuation">.</span><span class="token function-variable function">writeHello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  dounment<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>helloInLang<span class="token punctuation">[</span>lang<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// other.js</span>
<span class="token keyword">function</span> <span class="token function">writeHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  dounment<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;another same function broken&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>(实际上，这种模式本质还是操作全局对象，在其他模块上也能被修改，安全性很低。所以出现了<em>闭包模块化模式</em>，解决私有变量的问题)</p> <p><strong>IIFE 模式</strong></p> <p>立即执行函数(immediately-invoked function expression),简称 IIFE，它是一个 JavaScript 函数，可以在函数内部定义方法及私有属性，相当于一个封闭的作用域</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// greeting.js</span>
<span class="token keyword">var</span> greeting <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> helloInLang <span class="token operator">=</span> <span class="token punctuation">{</span>
    en<span class="token punctuation">:</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">,</span>
    es<span class="token punctuation">:</span> <span class="token string">&quot;Hola mundo!&quot;</span><span class="token punctuation">,</span>
    cn<span class="token punctuation">:</span> <span class="token string">&quot;你好 世界!&quot;</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">getHello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">helloInLang</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">writeHello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">lang</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">getHello</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> module
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>IIFE 可以形成一个独立的作用域，其中声明的变量只在该作用域下，从而达到实现私有变量的目的，如上述例子中的 <code>helloInLang</code> 在该 IIFE 外是不能直接访问和操作的，但可以通过暴露一些方法来访问或操作，如 <code>getHello</code>和<code>writeHello</code>。虽然 IIFE 解决了依赖关系的问题，但是在使用上还是比较混乱，没有解决模块管理的问题，随着页面中使用的模块数量越来越多，开发者很难维护好他们之间的依赖关系。
以上几种方式都是通过约定实现模块化，在不同的开发者中还会有差别，为了统一开发过程和不同项目之间的差异，我们需要一个标准去规范模块化的实现</p> <h2 id="模块化规范有哪几种？"><a href="#模块化规范有哪几种？" aria-hidden="true" class="header-anchor">#</a> 模块化规范有哪几种？</h2> <h3 id="commonjs"><a href="#commonjs" aria-hidden="true" class="header-anchor">#</a> CommonJS</h3> <p><strong>概述</strong> 是一种为JS表现指定的规范，更适用于服务端模块规范，我们熟悉的 Node.js 就是采用了这个规范。核心思想是：每个文件就是一个模块，有自己的作用域。在一个文件里面定义的变量、函数、类都是私有的，对其他文件不可见。通过exports或module.exports来导出暴露接口，通过reuqire 同步加载要依赖的模块</p> <p><strong>基本语法</strong></p> <ul><li>定义模块<div class="language- extra-class"><pre class="language-text"><code>module.exports = value 
或 exports.xxx = value
</code></pre></div></li> <li>引入模块<div class="language- extra-class"><pre class="language-text"><code>require(xxx) 
// 如果是第三方模块，xxx为模块名
// 如果是自定义模块，xxx为模块文件路径
</code></pre></div></li></ul> <p><em>require命令</em>加载模块文件，基本功能是读入并执行一个JavaScript文件，返回该模块的exports对象，如果没有找到指定模块会报错</p> <p><strong>特点</strong></p> <ul><li>适用于服务端编程,如Node.js</li> <li>所有代码都运行在模块作用域，不会污染全局作用域</li> <li>模块可以多次加载，但只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载就直接读取缓存结果；要想让模块再次运行，必须清除缓存</li> <li>模块加载的顺序，按照其在代码中出现的顺序</li> <li>模块输出的是一个<em>值的拷贝</em></li></ul> <p><strong>实现</strong>：</p> <p>eg:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// math.js</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'Yolanda'</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token number">22</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>age <span class="token operator">+=</span> num
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  counter<span class="token punctuation">,</span>
  obj<span class="token punctuation">,</span>
  add
<span class="token punctuation">}</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./math'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>counter
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./math'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>obj
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// name: Yolanda,age: 22</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span> <span class="token comment">// 0</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// add</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span> <span class="token comment">// 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// name: Yolanda,age: 24</span>

</code></pre></div><p>虽然以上代码实现了模块化，但应用于浏览器环境，是有局限性的：代码<code>console.log(obj)</code>必须在第十四行代码<code>const obj = require('./math').obj</code>加载完成后才能执行，如果加载时间很长，就会导致浏览器处于'假死'状态.因此浏览器环境不适用于以上的'同步加载'方式，只能采用'异步加载'模块，这就是AMD规范诞生的背景</p> <h3 id="amd"><a href="#amd" aria-hidden="true" class="header-anchor">#</a> AMD</h3> <p><strong>概述</strong>: AMD(Asynchromous Module Definition),意思是异步模块定义，它采用异步方式加载模块，模块的加载不影响后面的语句执行，所有依赖这个模块的语句，都定义在一个回调函数中，等加载完成后这个回调函数才调用</p> <p><strong>基本语法</strong></p> <ul><li>定义模块<div class="language- extra-class"><pre class="language-text"><code>define(['m1', 'm2'], function(m1, m2) { return 模块})
</code></pre></div></li> <li>加载模块<div class="language- extra-class"><pre class="language-text"><code>require(['m1', 'm2'], function(m1, m2) { // 使用m1、m2})
</code></pre></div></li></ul> <p><strong>特点</strong></p> <ul><li>适用于浏览器环境</li> <li>定义清晰，不会污染全局变量，能清楚地显式依赖关系</li> <li>允许异步加载模块，也可以根据需要动态加载模块</li> <li>提前加载,推崇依赖前置</li></ul> <p><strong>实现</strong>：
eg: 目前有一个流行库 <a href="https://requirejs.org/" target="_blank" rel="noopener noreferrer">require.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 主要用于客户端的模块管理</p> <p>文件结构目录：</p> <div class="language- extra-class"><pre class="language-text"><code>|-src
  |-libs
    |-require.js
  |-demo
    |-demo
      |-demo3
        |-add.js
        |-alter.js
        |-sub.js
        |-thirdModule.js
  |-main.js
  |-index.html
</code></pre></div><p><em>依赖模块</em></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// add.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了add模块'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> add
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// alter.js文件</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'thirdModule'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">thirdModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了alter模块'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'alter模块中引入了thirdModule'</span>
  <span class="token keyword">const</span> alter <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  alter<span class="token punctuation">.</span><span class="token function-variable function">showMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>thirdModule<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> alter
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// thirdModule.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">&quot;AMD模式加载['add', 'alter', 'sub']&quot;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了third模块'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> msg
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> getMsg <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// sub.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了sub模块'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">sub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">-</span> b
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sub
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><em>主模块</em></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js文件</span>
require<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// baseUrl: 'js',</span>
    paths<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      add<span class="token punctuation">:</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span>
      alter<span class="token punctuation">:</span> <span class="token string">&quot;alter&quot;</span><span class="token punctuation">,</span>
      sub<span class="token punctuation">:</span> <span class="token string">&quot;sub&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token string">'alter'</span><span class="token punctuation">,</span> <span class="token string">'sub'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">add<span class="token punctuation">,</span> alter<span class="token punctuation">,</span> sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    alter<span class="token punctuation">.</span><span class="token function">showMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 打印结果</span>
<span class="token comment">// 加载了add模块</span>
<span class="token comment">// 加载了sub模块</span>
<span class="token comment">// 加载了third模块</span>
<span class="token comment">// 加载了alter模块</span>
<span class="token comment">// 9</span>
<span class="token comment">// 6</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>// index.html文件
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Modular Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 引入require.js并指定js主文件的入口 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">data-main</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./js/index.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./libs/require.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- data-main指定主模块文件 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>小结</strong>：说明了AMD一个特性是提前加载,推崇依赖前置</p> <p><strong>补充：</strong> <code>require.config()</code>方法可以自定义模块加载行为，就写在主模块index.js的头部</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token comment">//  假设这些文件都与index.js不在同一个目录</span>
  require<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    baseUrl<span class="token punctuation">:</span> <span class="token string">'js/lib'</span><span class="token punctuation">,</span>
    paths<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'jQuery'</span><span class="token punctuation">:</span> <span class="token string">'jquery.min'</span><span class="token punctuation">,</span> <span class="token comment">// 或者改成 'lib/jquery.min' 去掉baseUrl</span>
      <span class="token string">'underscore'</span><span class="token punctuation">:</span> <span class="token string">'underscore.min'</span><span class="token punctuation">,</span>
      <span class="token string">'backbone'</span><span class="token punctuation">:</span> <span class="token string">'backbone.min'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  require<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    paths<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 指定各个模块的加载路径 假设这些文件都与index.js在同一个目录(js子目录)</span>
      <span class="token string">'jQuery'</span><span class="token punctuation">:</span> <span class="token string">'jquery.min'</span><span class="token punctuation">,</span>
      <span class="token string">'underscore'</span><span class="token punctuation">:</span> <span class="token string">'underscore.min'</span><span class="token punctuation">,</span>
      <span class="token string">'backbone'</span><span class="token punctuation">:</span> <span class="token string">'backbone.min'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>


</code></pre></div><p><strong>注意</strong>：如果需要加载不符合规范的模块，可以采用<code>require.config()</code>进行改造，利用<code>require.config()</code>中的<code>shim</code>属性定义一些特征：
eg:</p> <div class="language-js extra-class"><pre class="language-js"><code>  require<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    shim<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'underscore'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">export</span><span class="token punctuation">:</span> <span class="token string">'_'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'backbone'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        deps<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'underscore'</span><span class="token punctuation">,</span> <span class="token string">'jquery'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 表明这个模块的依赖性</span>
        <span class="token keyword">export</span><span class="token punctuation">:</span> <span class="token string">'Backbone'</span>                <span class="token comment">// 定义这个模块外部调用时的名称</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="cmd"><a href="#cmd" aria-hidden="true" class="header-anchor">#</a> CMD</h3> <p><strong>概述</strong>: CMD规范专门用于浏览器，模块是异步加载，推崇就近依赖，也就是在使用时再引入模块。<strong>CMD</strong> 整合了 ConmmonJS 和 AMD 规范的特点。<a href="https://github.com/seajs/seajs/edit/master/dist/sea.js" target="_blank" rel="noopener noreferrer">SeaJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个适用于 Web 浏览器端的模块加载器，使用 SeaJS，所有的模块都遵循 CMD 规范，可以更好地组织 JavaScript 代码</p> <p><strong>基本语法</strong></p> <ul><li>定义暴露模块<div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 有依赖时 同步引入</span>
    <span class="token keyword">var</span> module2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module2'</span><span class="token punctuation">)</span>
    <span class="token comment">// 有依赖时 异步引入</span>
    reuqire<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">'./module3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    exports<span class="token punctuation">.</span>xxx <span class="token operator">=</span> value <span class="token comment">// 用于在模块内部对外提供接口</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li>引入模块<div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> m1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module1'</span><span class="token punctuation">)</span>
    m1<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module4'</span><span class="token punctuation">)</span>
    m4<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <p><strong>实现</strong>
eg: 以Sea.js为例</p> <p>文件结构目录：</p> <div class="language- extra-class"><pre class="language-text"><code>|-src
|-libs
  |-require.js
|-demo
  |-demo
    |-demo3
      |-add.js
      |-alter.js
      |-sub.js
      |-thirdModule.js
|-main.js
|-index.html
</code></pre></div><p><em>依赖模块</em></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// module1.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了module1'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token string">'hello this is modulue1'</span>
  <span class="token keyword">const</span> <span class="token function-variable function">show</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module1 show() </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  exports<span class="token punctuation">.</span>show <span class="token operator">=</span> show
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// module2.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了module2'</span><span class="token punctuation">)</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    msg<span class="token punctuation">:</span> <span class="token string">'I will back'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// module3.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了module3'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token constant">API_KEY</span> <span class="token operator">=</span> <span class="token string">'abc123'</span>
  exports<span class="token punctuation">.</span><span class="token constant">API_KEY</span> <span class="token operator">=</span> <span class="token constant">API_KEY</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// module4.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了module4'</span><span class="token punctuation">)</span>
  <span class="token comment">// 同步引入依赖</span>
  <span class="token keyword">const</span> module2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module2'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">show</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module4 show()</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module2<span class="token punctuation">.</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  exports<span class="token punctuation">.</span>show <span class="token operator">=</span> show
  <span class="token comment">// 或者 module.exports = { show }</span>
  require<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">'./module3'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">m3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">异步引入依赖</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m3<span class="token punctuation">.</span><span class="token constant">API_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><em>主模块</em></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// main.js </span>
  <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> m1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module1'</span><span class="token punctuation">)</span>
    m1<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> m4 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module4'</span><span class="token punctuation">)</span>
    m4<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 打印结果</span>
  <span class="token comment">// 加载了module1</span>
  <span class="token comment">// module1 show() hello this is module1</span>
  <span class="token comment">// 加载了module4</span>
  <span class="token comment">// 加载了module2</span>
  <span class="token comment">// module4 show() hello this is module2</span>
  <span class="token comment">// 加载了module3</span>
  <span class="token comment">// 异步引入依赖 hello this is module3</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>  // index.html文件
  <span class="token doctype">&lt;!DOCTYPE html&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Modular Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./libs/sea.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        seajs<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'./main.js'</span><span class="token punctuation">)</span>
      </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>require.async(id, callback)</strong> 方法用于模块内部异步加载模块，并在加载完成后执行指定回调，callback参数可选.一般用来加载可延迟异步加载的模块</p> <h3 id="umd"><a href="#umd" aria-hidden="true" class="header-anchor">#</a> UMD</h3> <p><strong>概述</strong> UMD(Universal Module Definition) 通用模块规范，是整和了AMD和CommonJS的规范，通过判断是支持node.js的模块关键字<strong>exports</strong> 还是支持AMD的模块的关键字<strong>define</strong>是否存在来判断使用何种规范(注意，不支持 CMD 规范)</p> <p><strong>基础语法</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module<span class="token punctuation">.</span>exports <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'是commonjs模块规范，nodejs环境'</span><span class="token punctuation">)</span>
      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'是AMD模块规范，如require.js'</span><span class="token punctuation">)</span>
      <span class="token function">define</span><span class="token punctuation">(</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// } else if (typeof define === 'function' &amp;&amp; define.cmd) {</span>
  <span class="token comment">//     console.log('是CMD模块规范，如sea.js')</span>
  <span class="token comment">//     define(function(require, exports, module) {</span>
  <span class="token comment">//         module.exports = factory()</span>
  <span class="token comment">//     })</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'没有模块环境，直接挂载在全局对象上'</span><span class="token punctuation">)</span>
      root<span class="token punctuation">.</span>umdModule <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>
      <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
      add
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>实现</strong>
eg: 通过webpack打包一个自定义模块
<img src="/Notebook/assets/img/webpack-umd.cc021f27.png" alt=""></p> <p><strong>打包后的文件</strong> <img src="/Notebook/assets/img/webpack-bundle.f2dbc97e.png" alt=""></p> <p>如何使用这个打包后的bundle.js文件呢？很明显，UMD支持AMD和CommonJS规范，以下几种方式都可引用 bundle.js</p> <p><strong>umd-use-by-global</strong> 没有模块环境，直接挂载在全局对象上</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>../../../dist/bundle.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>umd-use-by-require</strong> RequireJS 加载 UMD 模块
入口文件 index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用 requirejs 加载 bundle.js</span>
require<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    baseUrl<span class="token punctuation">:</span> <span class="token string">'../../../dist'</span><span class="token punctuation">,</span>
    paths<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      add<span class="token punctuation">:</span> <span class="token string">&quot;bundle&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'add'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">add</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">data-main</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./js/use-by-require.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>../../libs/require.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>umd-use-in-node</strong> node 环境加载 UMD</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> add <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../dist/bundle.js'</span><span class="token punctuation">)</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment">// 命令行敲 node ./src/main.js</span>
</code></pre></div><p><strong>注意</strong>需要在webpack.config.js中配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  globalObject<span class="token punctuation">:</span> <span class="token string">'typeof self !== \'undefined\' ? self : this'</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>umd-use-by-sea</strong>
如果想要 umd 模块被 SeaJS 加载，需要在 bundle.js 做以下处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// (function(root, factory) {</span>
<span class="token comment">//     if (typeof module === 'object' &amp;&amp; typeof module.exports === 'object') {</span>
<span class="token comment">//         console.log('是commonjs模块规范，nodejs环境')</span>
<span class="token comment">//         module.exports = factory();</span>
<span class="token comment">//     } else if (typeof define === 'function' &amp;&amp; define.amd) {</span>
<span class="token comment">//         console.log('是AMD模块规范，如require.js')</span>
<span class="token comment">//         define(factory())</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'是CMD模块规范，如sea.js'</span><span class="token punctuation">)</span>
        <span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//     } else {</span>
<span class="token comment">//         console.log('没有模块环境，直接挂载在全局对象上')</span>
<span class="token comment">//         root.umdModule = factory();</span>
<span class="token comment">//     }</span>
<span class="token comment">// }(this, function(a, b) {</span>
<span class="token comment">//     const add = (a, b) =&gt; {</span>
<span class="token comment">//         console.log(a + b)</span>
<span class="token comment">//         return a + b</span>
<span class="token comment">//     }</span>
<span class="token comment">//     return {</span>
<span class="token comment">//         add</span>
<span class="token comment">//     }</span>
<span class="token comment">// }))</span>
</code></pre></div><p>入口文件：index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../../dist/bundle'</span><span class="token punctuation">)</span>
<span class="token function">bundle</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment">// 使用 seajs 加载 bundle-umd.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../../dist/bundle'</span><span class="token punctuation">)</span>
  <span class="token comment">// const bundle = require('./factory')</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'使用 seajs 加载 bundle.js'</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#add'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">add 1 to 4, sum is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bundle</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>../../libs/sea.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    seajs<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'./js/use-by-sea.js'</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>不建议在 html 中使用<code>import</code> 引入umd 模块。即便 es6 提供了<code>script</code>标签属性<code>type=&quot;module&quot;</code>支持es6语法引入模块的API</p> <div class="language-html extra-class"><pre class="language-html"><code>// index.html文件
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../dist/bundle.js'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 报错</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>报错</strong>目标文件找不到提供的add</p> <p><img src="data:image/png;base64,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" alt=""></p> <p><strong>原因</strong> 打包后的 bundle 文件只支持 AMD 或 CommonJS 规范,所以并没有提供 ES6 规范对应所需的<strong>import/exports</strong>语法,如果在一个 vue-cli 搭建的项目中引入这个 bundle 文件,是可以正常使用里面的方法,因为项目经过了<strong>babel</strong>处理, import 编译成 require ,就能识别bundle.js提供的 exports</p> <p><img src="/Notebook/assets/img/webpack-es6.4721c75d.png" alt=""></p> <p>总结：对于我们自己封装的库，使用 umd 规范是比较通用的，eye-map 组件库就是利用 rollup 构建成 umd 模块提供使用。（rollup是另一种常用的构建工具）</p> <h3 id="es6module"><a href="#es6module" aria-hidden="true" class="header-anchor">#</a> ES6Module</h3> <p><strong>概述</strong> ES6在语言标准层面上实现了模块功能,方式简单明了,依赖在编译时完成加载,取代了 CommonJS 和 AMD  规范,成为浏览器和服务端通用的模块解决方案</p> <p><strong>基础语法</strong></p> <ul><li>定义模块</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// add-es6.js</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span>
  <span class="token keyword">export</span> <span class="token punctuation">{</span> basicNum<span class="token punctuation">,</span> add <span class="token punctuation">}</span>
</code></pre></div><ul><li>引入模块</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">import</span> <span class="token punctuation">{</span> basicNum<span class="token punctuation">,</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./main'</span>
  <span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token parameter">ele</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ele<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">99</span> <span class="token operator">+</span> basicMum<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>或者：</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> add <span class="token keyword">from</span> <span class="token string">'./js/add-es6.js'</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#content'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'在 html 中引用 ES6 模块'</span>
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#add'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">add 1 to 3, sum is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意：当模块默认输出时，即采用 <code>export default</code>时，引入模块的名称可以为任意,且不需要花括号</p> <p>eg:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// export-default.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">const</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// other.js</span>
<span class="token keyword">import</span> <span class="token constant">B</span> <span class="token keyword">from</span> <span class="token string">'./export-defaule'</span>
<span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>ES6规范</strong>与<strong>CommonJS规范</strong>比较：</p> <ul><li><p>reuqire 使用于CommonJS规范, import 使用于ES6规范</p></li> <li><p><strong>CommonJS</strong></p> <ul><li>CommonJS输出的是<strong>值的拷贝</strong></li> <li>对于基本数据类型,调用模块内部方法对值进行修改,不会影响已导出模块的值,原模块的值也不会修改</li> <li>对于复杂数据类型,因为浅拷贝,两个对象指向同一个引用,如果对值进行修改,已导出,原模块的值都会修改</li> <li>CommonJS 模块是运行时加载</li> <li>当使用require命令加载某个模块时就会运行整个模块的代码,当重复执行加载相同模块时,不会再执行加载模块而是取缓存中的值,即只会在第一次加载运行一次,以后都会返回第一次加载的结果,除非手动清除缓存</li> <li>可以在任何位置，甚至条件的引入模块</li></ul></li> <li><p><strong>ES6</strong></p> <ul><li>ES6输出的是<strong>值的动态引用</strong></li> <li>对于基本数据类型,调用模块内部方法对值进行修改,会影响模块已导出的值,原模块的值也会修改</li> <li>对于复杂数据类型,如果对模块的值进行更改,模块已输出,原模块的值都会更改</li> <li>ES6模块是编译时输出接口</li> <li>由于ES模块是静态的，因此import语句只能位于模块的顶端，且不能条件的引入，为什么强制要求在模块顶部声明引入模块呢？因为这样webpack等工具可以快速获取代码的依赖关系树，可以查看未使用的代码并将其从打包工具中删除。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib.js</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'Yolanda'</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token number">22</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">incCounter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  counter<span class="token operator">++</span>
  obj<span class="token punctuation">.</span>age <span class="token operator">+=</span> n
<span class="token punctuation">}</span>
<span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> counter<span class="token punctuation">,</span> incCounter<span class="token punctuation">,</span> obj <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span> <span class="token comment">// 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// name: 'Yolanda', age: 22</span>
<span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span> <span class="token comment">// 1 如果是CommonJS这里还是0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token comment">// name: 'Yolanda', age: 24</span>
</code></pre></div></li></ul> <h2 id="模块化是如何实现的？"><a href="#模块化是如何实现的？" aria-hidden="true" class="header-anchor">#</a> 模块化是如何实现的？</h2> <p>我们主要学习 Node 是如何实现模块化的。大家都知道，<strong>模块系统</strong>是 <strong>nodejs</strong> 的基础，在我们使用过 node 过程，会有以下几个常见的问题？</p> <ul><li>为什么模块中有全局的 require、module.exports、exports、__dirname、__filename  等变量，它们是从哪里来的？</li> <li>为什么一定要使用 module.exports 或 exports 导出模块？</li> <li>module.exports 和 exports 的区别是什么？它们有什么关系？</li></ul> <p>我们通过分析 node 中关于模块源码 <code>lib/module.js</code> 来解决上面的困惑。经过第二部分模块化规范的介绍，我们知道 nodejs 是基于 CommonJS 规范，而 CommonJS 规范的两大特点是：</p> <ul><li>每个文件都是单独的一个模块，有自己的作用域，里面定义的变量、函数或类都是私有的，对其他文件不可见</li> <li>每个模块内部，module 变量代表着当前模块，它是一个对象，它的 exports 属性(即 module.exports)是对外的接口，require 加载模块实际是加载这个模块的 module.exports 属性</li></ul> <p>那么 <strong>require</strong> 是如何导入模块的？我们分析 <code>lib/module.js</code> 源码，模块导入流程如下：</p> <p><img src="/Notebook/assets/img/require.9c019fcc.png" alt=""></p> <p>接下来具体看一下源码：源码中的 require 方法是挂载在 Module 原型链上</p> <h3 id="module-prototype-require"><a href="#module-prototype-require" aria-hidden="true" class="header-anchor">#</a> Module.prototype.require</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 每个模块都对应一个 Module 实例，实例上主要有以下属性</span>
<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span> <span class="token comment">// 模块的识别符，通常是带有绝对路径的模块文件名</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 模块对外输出的值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span> <span class="token comment">// 返回一个对象，表示调用该模块的模块</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 模块的文件名，带有绝对路径</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否已加载模块标记</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 返回一个数组，表示该模块要用到的其他模块</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module <span class="token comment">// node 内部源码使用的也是模块系统</span>

<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Module<span class="token punctuation">.</span><span class="token function">_load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">/* isMain */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>所以，require 并不是全局命令，而是每个模块提供的一个<strong>内部</strong>方法，只有在模块内部才能调用 require 命令，而 require 方法中调用了 <code>Module._load</code> 方法</p> <h3 id="module-load"><a href="#module-load" aria-hidden="true" class="header-anchor">#</a> Module._load</h3> <p>下面来看 Module._load 的源码</p> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 第一步：计算绝对路径</span>
  <span class="token keyword">var</span> filename <span class="token operator">=</span>  Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
  <span class="token comment">// 第二步：缓存判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接从缓存中读取</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">.</span>exports
  <span class="token punctuation">}</span>
  <span class="token comment">// 第三步：实例化一个空的 module</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
  <span class="token comment">// 存入缓存</span>
  Module<span class="token punctuation">.</span>_cache <span class="token operator">=</span> module
  <span class="token comment">// 第四步：加载 module</span>
  module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
  <span class="token comment">// 第五步：输出 module.exports （问题2: 导出的是 exports 内容）</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面一部分源码可以看到，Module._load 的关键两个步骤是 获取模块的绝对路径和加载模块 module.load()，虽然每个模块都可以拿到自己的当前实例 module，但 module.load 是如何将空的实例注入到模块中呢？它的核心原理是利用<strong>沙箱环境，以闭包函数的方式传入当前module</strong></p> <h3 id="module-prototype-load"><a href="#module-prototype-load" aria-hidden="true" class="header-anchor">#</a> Module.prototype.load</h3> <p>在 <code>Module.prototype.load</code>方法中，根据接受到的模块绝对路径加载模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// module实例上可以拿到filename、paths属性</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>paths <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_nodeModulePaths</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// node引用模块可以默认不写后缀，顺序规则：.js、.json .node</span>
  <span class="token keyword">var</span> extension <span class="token operator">=</span> <span class="token function">findLongestRegisteredExtension</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 不同后缀的文件模块，使用不同的加载策略。</span>
  Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标记成模块已加载</span>
<span class="token punctuation">}</span>

<span class="token comment">// js 文件的加载策略</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获得模块代码纯字符串，然后编译compile字符串代码</span>
  <span class="token comment">// stripBOM方法作用是剥离 utf8 编码特有的BOM文件头</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span><span class="token function">stripBOM</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>可以看出，<code>Module.prototype.load</code> 方法主要做了两个处理：拿到 module 实例的 filename、path 属性和根据不同文件后缀进行模块加载，我们主要分析 js 文件的加载策略，首先它将文件读取成字符串代码，然后通过 <code>module._compile</code> 方法编译模块代码</p> <h3 id="module-prototype-compile"><a href="#module-prototype-compile" aria-hidden="true" class="header-anchor">#</a> Module.prototype._compile</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 给 Module 添加一个 wrap 属性，返回一个包装好的函数字符串</span>
<span class="token comment">// 最新版node使用Proxy，使得Module.wrap代理wrap对象</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Module<span class="token punctuation">,</span> <span class="token string">'wrap'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> wrap<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wrap <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">script</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> script <span class="token operator">+</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'(function (exports, require, module, __filename, __dirname) { '</span><span class="token punctuation">,</span>
  <span class="token string">'\n});'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将模块内容使用function包装起来</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 关键：通过内部vm模块方法，把string字符串代码，变成真正的可执行代码</span>
  <span class="token keyword">const</span> compiledWrapper <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> require <span class="token operator">=</span> <span class="token function">makeRequireFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对外暴露的require api</span>
  <span class="token comment">// 问题3：exports和module.exports的关系</span>
  <span class="token comment">// 即exports = module.exports = {}</span>

  <span class="token comment">// 问题1：在模块内部，拥有require、module、exports等全局变量</span>
  <span class="token comment">// 原理: 通过compiledWrapper.call执行函数，把这些内容传入到模块内部</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">compiledWrapper</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p><code>Module.prototype._compile</code> 是模块加载的核心内容，它的本质是<strong>将读取到的模块字符串源码拼接成闭包函数(通过 vm 模块的 runInThisContext 方法)，注入 exports、require、module 等全局变量，再执行模块源码，将 module.exports 值输出</strong>：</p> <p>等同于调用这样一个函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 模块内部定义代码</span>
  <span class="token keyword">const</span> otherModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./other'</span><span class="token punctuation">)</span> <span class="token comment">// 内部可以使用require、module等全局变量</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token comment">// 必须使用module.exports以导出本模块内容</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>require<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span>
</code></pre></div><h3 id="模块实现总结"><a href="#模块实现总结" aria-hidden="true" class="header-anchor">#</a> 模块实现总结</h3> <ol><li>模块的加载，是通过<strong>沙箱</strong>方式，把字符串拼接成闭包函数的形式，把新建实例module、exports、require、filename、dirname 以参数的形式注入到环境变量中</li> <li>模块的导出，必须使用 module.exports ，exports 是 module.exports 的别名，它们指向同一块内存</li> <li>exports = module.exports, 但 exports 被覆盖时，即赋值操作 <code>exports = ...</code> 后，不再指向 module.exports</li> <li>使用 node 的 vm 模块，能创建独立的沙箱环境，并将字符串代码转换成可执行代码，实现一些非常规需求</li></ol> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <ul><li>CommonJS规范主要用于<em>服务端</em>编程，加载模块是<em>同步</em>的，这并不适合在浏览器环境，因为同步意味着阻塞加载，浏览器资源是异步的，因此有了AMD、CMD</li> <li>AMD规范在<em>浏览器环境</em>中<em>异步</em>加载模块，推崇依赖前置，而且可以并行加载多个模块。但是AMD规范开发成本较高，代码阅读和书写比较困难，模块定义方式语义不顺畅</li> <li>CMD规范与AMD规范很相似，都用于<em>浏览器</em>编程，依赖就近，延迟执行，可以很容易在<em>Node.js</em>中运行，不过它依赖SPM打包，模块加载逻辑偏重</li> <li>ES6在语言标准层面上，实现了模块功能，代码简单清晰，成为浏览器和服务端通用的模块解决方案</li> <li>UMD通过判断支持node.js的模块exports、支持AMD的模块define是否存在来判断使用何种规范,是目前比较通用的规范之一</li></ul> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <p><a href="https://nodejs.org/api/fs.html#fs_fs_readfilesync_path_options" target="_blank" rel="noopener noreferrer">fs.readFileSync<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://nodejs.org/api/vm.html" target="_blank" rel="noopener noreferrer">vm.runInThisContext<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://tylermcginnis.com/javascript-modules-iifes-commonjs-esmodules/" target="_blank" rel="noopener noreferrer">https://tylermcginnis.com/javascript-modules-iifes-commonjs-esmodules/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="手写req-方法（补充）"><a href="#手写req-方法（补充）" aria-hidden="true" class="header-anchor">#</a> 手写req 方法（补充）</h2> <p>我们模仿源码去写一个简单的 req 函数：</p> <p>基本思路：
<img src="/Notebook/assets/img/my-req.24bcc660.png" alt=""></p> <p>根据思路，我们一步步将目标原理实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// req.js</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//node原生的模块，用来读写文件(fileSystem)</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//node原生的模块，用来解析文件路径</span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//提供了一系列 API 用于在 V8 虚拟机环境中编译和运行代码。</span>

<span class="token comment">//Module类，就相当于我们的模块(因为node环境不支持es6的class，这里用function)</span>
<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> p
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filepath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//所有的加载策略</span>
Module<span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">{</span> 
  <span class="token string">&quot;.js&quot;</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">moudle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如何加载？</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;.json&quot;</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;.node&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;XXX&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">//以绝对路径为key存储一个module</span>
Module<span class="token punctuation">.</span>_cacheModule <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 获取绝对路径方法</span>
Module<span class="token punctuation">.</span><span class="token function-variable function">_resolveFileName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token keyword">return</span> p
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取所需模块的绝对路径</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFileName</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据绝对路径，查找是否有模块缓存</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_cacheModule<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Module<span class="token punctuation">.</span>_cacheModule<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span>exports
  <span class="token punctuation">}</span>
  <span class="token comment">// 没有缓存即生成一个实例</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 加载模块</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span>
</code></pre></div><p><strong>.js文件</strong>的加载策略又是什么, 先了解一下 NodeJS 的 VM 模块：</p> <p><strong>VM</strong> 是 NodeJS 里的核心模块，支撑了 require 方法和 NodeJS 的运行机制。通过 VM 模块， JS 可以被编译后立即执行或者编译后保存下来稍后执行，VM 中常见的一个方法是创建独立运行的沙箱机制 <code>vm.runInThisContext()</code></p> <p>通过 <strong>runInThisContext()</strong> 创建一个独立的沙箱运行空间，code 内的代码可以访问外部的 <strong>global</strong> 对象，且 code 内部的 global 与外部共享</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">5</span>
global<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">11</span>

vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token string">'console.log('</span>ok<span class="token string">', a)'</span><span class="token punctuation">)</span> <span class="token comment">// 显示 global 的 11</span>
vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token string">'console.log(global)'</span><span class="token punctuation">)</span> <span class="token comment">// 显示 global</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 显示 5</span>
</code></pre></div><p><strong>针对 <code>.js</code> 文件的加载策略</strong></p> <p>它主要是通过 compile 这个方法去编译执行我们的模块文件。那么 compile 方法做了哪些处理呢？我们清楚知道，目的是通过读取模块文件来获取模块的输出，但是 node中并没有这样一种方法，所以就需要以下几个步骤进行转换：</p> <ul><li><p>首先，读取我们的模块文件，通过fs.readFileSync方法，指定输出格式为 utf-8，也就是字符串形式</p></li> <li><p>其次，怎么让外部的module.exports取得字符串内的内容？需要用到一个 Module._wrapper 包装类，将输出的模块字符串拼接成一个自执行函数字符串</p></li> <li><p>最后，通过vm.runINThisContext方法执行这个函数字符串并注入参数，使得module实例中的exports成功赋值为模块的输出</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token comment">// 经过 compile, 将 js 文件内容包裹成一个函数， 注入 exports、require、module、_dirname、_filename 变量</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token comment">// 最终</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Module._compile</strong> 编译执行js文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//js文件加载的包装类</span>
Module<span class="token punctuation">.</span>_wrapper <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;(function(exports,require,module,__dirname,__filename){&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;\n})&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
Module<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取包装后的函数体</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> Module<span class="token punctuation">.</span>_wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> content <span class="token operator">+</span> Module<span class="token punctuation">.</span>_wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
  <span class="token comment">// vm 是 nodejs 的虚拟机沙盒模块，runInThisContext 方法接受一个字符串并将字符串转换成可执行的js代码</span>
  vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>require<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> dirname<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token comment">// 此后 共享 module.exports</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/21/2020, 10:35:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Notebook/frontend-web/" class="prev router-link-active">
          工程化
        </a></span> <span class="next"><a href="/Notebook/frontend-web/architecture.html">
          架构
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Notebook/assets/js/app.fae3116e.js" defer></script><script src="/Notebook/assets/js/3.8a90166b.js" defer></script><script src="/Notebook/assets/js/15.edab26a3.js" defer></script>
  </body>
</html>
