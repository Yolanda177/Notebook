<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>文件处理 | Yolanda</title>
    <meta name="description" content="每天学习一点点">
    <link rel="icon" href="/Notebook/images/mylogo.jpg">
    
    <link rel="preload" href="/Notebook/assets/css/0.styles.4f932b82.css" as="style"><link rel="preload" href="/Notebook/assets/js/app.fae3116e.js" as="script"><link rel="preload" href="/Notebook/assets/js/3.8a90166b.js" as="script"><link rel="preload" href="/Notebook/assets/js/5.01244a1f.js" as="script"><link rel="prefetch" href="/Notebook/assets/js/10.7c0500f6.js"><link rel="prefetch" href="/Notebook/assets/js/11.96ce6645.js"><link rel="prefetch" href="/Notebook/assets/js/12.295d52cd.js"><link rel="prefetch" href="/Notebook/assets/js/13.6db71019.js"><link rel="prefetch" href="/Notebook/assets/js/14.0c1400d8.js"><link rel="prefetch" href="/Notebook/assets/js/15.edab26a3.js"><link rel="prefetch" href="/Notebook/assets/js/16.88fd161d.js"><link rel="prefetch" href="/Notebook/assets/js/17.408350d5.js"><link rel="prefetch" href="/Notebook/assets/js/18.6ab68d1c.js"><link rel="prefetch" href="/Notebook/assets/js/19.9e9ef1da.js"><link rel="prefetch" href="/Notebook/assets/js/2.e3a9cac0.js"><link rel="prefetch" href="/Notebook/assets/js/20.56c42c66.js"><link rel="prefetch" href="/Notebook/assets/js/21.8d087c07.js"><link rel="prefetch" href="/Notebook/assets/js/22.cf2b0a03.js"><link rel="prefetch" href="/Notebook/assets/js/23.7413880a.js"><link rel="prefetch" href="/Notebook/assets/js/24.28bab990.js"><link rel="prefetch" href="/Notebook/assets/js/25.75c60686.js"><link rel="prefetch" href="/Notebook/assets/js/26.ef1edf61.js"><link rel="prefetch" href="/Notebook/assets/js/27.5aeea7cc.js"><link rel="prefetch" href="/Notebook/assets/js/28.8476b7e4.js"><link rel="prefetch" href="/Notebook/assets/js/29.956345a3.js"><link rel="prefetch" href="/Notebook/assets/js/30.b96e226e.js"><link rel="prefetch" href="/Notebook/assets/js/31.04440a69.js"><link rel="prefetch" href="/Notebook/assets/js/32.273112ca.js"><link rel="prefetch" href="/Notebook/assets/js/33.e709b2b3.js"><link rel="prefetch" href="/Notebook/assets/js/34.dc2136ae.js"><link rel="prefetch" href="/Notebook/assets/js/35.30ab0118.js"><link rel="prefetch" href="/Notebook/assets/js/36.cb41bc4a.js"><link rel="prefetch" href="/Notebook/assets/js/37.dd26a76e.js"><link rel="prefetch" href="/Notebook/assets/js/38.68398169.js"><link rel="prefetch" href="/Notebook/assets/js/39.93b8990e.js"><link rel="prefetch" href="/Notebook/assets/js/4.5f27db7e.js"><link rel="prefetch" href="/Notebook/assets/js/40.ed267aa9.js"><link rel="prefetch" href="/Notebook/assets/js/41.985eec03.js"><link rel="prefetch" href="/Notebook/assets/js/42.260a858d.js"><link rel="prefetch" href="/Notebook/assets/js/43.6cb97df7.js"><link rel="prefetch" href="/Notebook/assets/js/44.869ede03.js"><link rel="prefetch" href="/Notebook/assets/js/45.bf3e5a26.js"><link rel="prefetch" href="/Notebook/assets/js/46.a54b425c.js"><link rel="prefetch" href="/Notebook/assets/js/47.8ebe066b.js"><link rel="prefetch" href="/Notebook/assets/js/48.416ad307.js"><link rel="prefetch" href="/Notebook/assets/js/49.7394cd78.js"><link rel="prefetch" href="/Notebook/assets/js/50.4675f4c4.js"><link rel="prefetch" href="/Notebook/assets/js/51.a112471f.js"><link rel="prefetch" href="/Notebook/assets/js/52.a6195fbf.js"><link rel="prefetch" href="/Notebook/assets/js/53.15f5f0a8.js"><link rel="prefetch" href="/Notebook/assets/js/54.bbc6eb3c.js"><link rel="prefetch" href="/Notebook/assets/js/55.ba5d1f28.js"><link rel="prefetch" href="/Notebook/assets/js/56.2d5a7c0d.js"><link rel="prefetch" href="/Notebook/assets/js/57.b6f47637.js"><link rel="prefetch" href="/Notebook/assets/js/58.3ce0f8ce.js"><link rel="prefetch" href="/Notebook/assets/js/59.66784ebf.js"><link rel="prefetch" href="/Notebook/assets/js/6.4d03de1b.js"><link rel="prefetch" href="/Notebook/assets/js/60.2c355106.js"><link rel="prefetch" href="/Notebook/assets/js/61.1fb23164.js"><link rel="prefetch" href="/Notebook/assets/js/62.5ee4cd1c.js"><link rel="prefetch" href="/Notebook/assets/js/63.08a71f63.js"><link rel="prefetch" href="/Notebook/assets/js/64.e7464a6a.js"><link rel="prefetch" href="/Notebook/assets/js/65.de9108af.js"><link rel="prefetch" href="/Notebook/assets/js/66.83e75f1b.js"><link rel="prefetch" href="/Notebook/assets/js/67.3caaf58d.js"><link rel="prefetch" href="/Notebook/assets/js/68.2dd69095.js"><link rel="prefetch" href="/Notebook/assets/js/69.927efe78.js"><link rel="prefetch" href="/Notebook/assets/js/7.a97cfeeb.js"><link rel="prefetch" href="/Notebook/assets/js/70.92fd8264.js"><link rel="prefetch" href="/Notebook/assets/js/71.0ef73e07.js"><link rel="prefetch" href="/Notebook/assets/js/72.7e0a2fee.js"><link rel="prefetch" href="/Notebook/assets/js/73.816bc4b8.js"><link rel="prefetch" href="/Notebook/assets/js/74.e1c44e90.js"><link rel="prefetch" href="/Notebook/assets/js/75.52d5991e.js"><link rel="prefetch" href="/Notebook/assets/js/76.3ab263b9.js"><link rel="prefetch" href="/Notebook/assets/js/77.76e6e752.js"><link rel="prefetch" href="/Notebook/assets/js/78.e2711be8.js"><link rel="prefetch" href="/Notebook/assets/js/79.ecf0c259.js"><link rel="prefetch" href="/Notebook/assets/js/8.698b291a.js"><link rel="prefetch" href="/Notebook/assets/js/80.6defbc57.js"><link rel="prefetch" href="/Notebook/assets/js/81.650b6435.js"><link rel="prefetch" href="/Notebook/assets/js/82.f41e2c82.js"><link rel="prefetch" href="/Notebook/assets/js/83.62a3d0ce.js"><link rel="prefetch" href="/Notebook/assets/js/84.f2e0ba7a.js"><link rel="prefetch" href="/Notebook/assets/js/85.7d5af1cd.js"><link rel="prefetch" href="/Notebook/assets/js/86.883b02f7.js"><link rel="prefetch" href="/Notebook/assets/js/87.dc5913fb.js"><link rel="prefetch" href="/Notebook/assets/js/88.369e5f01.js"><link rel="prefetch" href="/Notebook/assets/js/89.fd496723.js"><link rel="prefetch" href="/Notebook/assets/js/9.220abfab.js"><link rel="prefetch" href="/Notebook/assets/js/90.1d16c82f.js"><link rel="prefetch" href="/Notebook/assets/js/91.6bcdcb57.js"><link rel="prefetch" href="/Notebook/assets/js/92.3f6beaea.js"><link rel="prefetch" href="/Notebook/assets/js/93.d98ca184.js">
    <link rel="stylesheet" href="/Notebook/assets/css/0.styles.4f932b82.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Notebook/" class="home-link router-link-active"><!----> <span class="site-name">Yolanda</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Notebook/dailyRecord/" class="nav-link">📝日常记录</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发者</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/frontend-web/" class="nav-link router-link-active">💻大前端</a></li><li class="dropdown-item"><!----> <a href="/Notebook/rethink/" class="nav-link">🤔复盘</a></li><li class="dropdown-item"><h4>️️🧘算法修炼</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notebook/algorithm/computerBasics.html" class="nav-link">计算机基础</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/dataStructure.html" class="nav-link">数据结构</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/algorithm.html" class="nav-link">算法分类</a></li><li class="dropdown-subitem"><a href="/Notebook/dataBase/index.html" class="nav-link">数据库</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Notebook/devops/" class="nav-link">☁️运维</a></li><li class="dropdown-item"><!----> <a href="/Notebook/test/" class="nav-link">🚬测试</a></li><li class="dropdown-item"><!----> <a href="/Notebook/gis/" class="nav-link">🌍GIS</a></li><li class="dropdown-item"><!----> <a href="/Notebook/software/" class="nav-link">️️🖱️软件</a></li><li class="dropdown-item"><!----> <a href="/Notebook/network/" class="nav-link">️️🐛网络工程</a></li><li class="dropdown-item"><!----> <a href="/Notebook/csharp/" class="nav-link">🚗C#</a></li><li class="dropdown-item"><!----> <a href="/Notebook/unity/" class="nav-link">🎮Unity</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">设计</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/design/" class="nav-link">🖌️UI</a></li></ul></div></div><div class="nav-item"><a href="/Notebook/bookmark/" class="nav-link">🏷书签整理</a></div><div class="nav-item"><a href="/Notebook/lint/" class="nav-link">✔️编码规范&amp;协同开发</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  📖知识脑图
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://jecyu.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  🔧个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🔗Github</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Yolanda177" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Yolanda github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/language-learning/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英语学习
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/Fe-Auto-Testing/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端自动化测试
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Notebook/dailyRecord/" class="nav-link">📝日常记录</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发者</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/frontend-web/" class="nav-link router-link-active">💻大前端</a></li><li class="dropdown-item"><!----> <a href="/Notebook/rethink/" class="nav-link">🤔复盘</a></li><li class="dropdown-item"><h4>️️🧘算法修炼</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Notebook/algorithm/computerBasics.html" class="nav-link">计算机基础</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/dataStructure.html" class="nav-link">数据结构</a></li><li class="dropdown-subitem"><a href="/Notebook/algorithm/algorithm.html" class="nav-link">算法分类</a></li><li class="dropdown-subitem"><a href="/Notebook/dataBase/index.html" class="nav-link">数据库</a></li></ul></li><li class="dropdown-item"><!----> <a href="/Notebook/devops/" class="nav-link">☁️运维</a></li><li class="dropdown-item"><!----> <a href="/Notebook/test/" class="nav-link">🚬测试</a></li><li class="dropdown-item"><!----> <a href="/Notebook/gis/" class="nav-link">🌍GIS</a></li><li class="dropdown-item"><!----> <a href="/Notebook/software/" class="nav-link">️️🖱️软件</a></li><li class="dropdown-item"><!----> <a href="/Notebook/network/" class="nav-link">️️🐛网络工程</a></li><li class="dropdown-item"><!----> <a href="/Notebook/csharp/" class="nav-link">🚗C#</a></li><li class="dropdown-item"><!----> <a href="/Notebook/unity/" class="nav-link">🎮Unity</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">设计</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Notebook/design/" class="nav-link">🖌️UI</a></li></ul></div></div><div class="nav-item"><a href="/Notebook/bookmark/" class="nav-link">🏷书签整理</a></div><div class="nav-item"><a href="/Notebook/lint/" class="nav-link">✔️编码规范&amp;协同开发</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  📖知识脑图
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://jecyu.github.io/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  🔧个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🔗Github</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Yolanda177" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Yolanda github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/language-learning/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英语学习
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jecyu.github.io/Fe-Auto-Testing/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端自动化测试
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Notebook/frontend-web/browser.html" class="sidebar-link">浏览器</a></li><li><a href="/Notebook/frontend-web/css.html" class="sidebar-link">CSS</a></li><li><a href="/Notebook/frontend-web/javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/Notebook/frontend-web/es6.html" class="sidebar-link">ES6</a></li><li><a href="/Notebook/frontend-web/react.html" class="sidebar-link">React</a></li><li><a href="/Notebook/frontend-web/vue.html" class="sidebar-link">Vue</a></li><li><a href="/Notebook/frontend-web/webpack.html" class="sidebar-link">webpack</a></li><li><a href="/Notebook/frontend-web/" class="sidebar-link">工程化</a></li><li><a href="/Notebook/frontend-web/modulization.html" class="sidebar-link">模块化</a></li><li><a href="/Notebook/frontend-web/architecture.html" class="sidebar-link">架构</a></li><li><a href="/Notebook/frontend-web/authentication.html" class="sidebar-link">鉴权&amp;&amp;认证</a></li><li><a href="/Notebook/frontend-web/chrome.html" class="sidebar-link">chrome 调试技巧</a></li><li><a href="/Notebook/frontend-web/noJQ.html" class="sidebar-link">You (Might) Don't Need jQuery</a></li><li><a href="/Notebook/frontend-web/performance.html" class="sidebar-link">性能优化</a></li><li><a href="/Notebook/frontend-web/npm.html" class="sidebar-link">npm</a></li><li><a href="/Notebook/frontend-web/lodash.html" class="sidebar-link">lodash 源码分析及思路学习</a></li><li><a href="/Notebook/frontend-web/babel.html" class="sidebar-link">Babel</a></li><li><a href="/Notebook/frontend-web/rollup.html" class="sidebar-link">rollup</a></li><li><a href="/Notebook/frontend-web/docker.html" class="sidebar-link">Docker</a></li><li><a href="/Notebook/frontend-web/security.html" class="sidebar-link">前端安全</a></li><li><a href="/Notebook/frontend-web/file.html" class="active sidebar-link">文件处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#常见场景" class="sidebar-link">常见场景</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#流" class="sidebar-link">流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#为什么要有流" class="sidebar-link">为什么要有流</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#上传" class="sidebar-link">上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#表单上传" class="sidebar-link">表单上传</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#formdata-异步上传" class="sidebar-link">formData 异步上传</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#拖拽上传" class="sidebar-link">拖拽上传</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#粘贴上传" class="sidebar-link">粘贴上传</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#大文件断点续传" class="sidebar-link">大文件断点续传</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#文件夹上传" class="sidebar-link">文件夹上传</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#下载" class="sidebar-link">下载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#a标签下载" class="sidebar-link">a标签下载</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#location-href下载" class="sidebar-link">location.href下载</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#iframe下载" class="sidebar-link">iframe下载</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#filesaver-下载" class="sidebar-link">FileSaver 下载</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#文件下载" class="sidebar-link">文件下载</a></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#文件在线生成" class="sidebar-link">文件在线生成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#截图" class="sidebar-link">截图</a></li></ul></li><li class="sidebar-sub-header"><a href="/Notebook/frontend-web/file.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/Notebook/frontend-web/interview.html" class="sidebar-link">常见问题 1</a></li><li><a href="/Notebook/frontend-web/interview2.html" class="sidebar-link">常见问题 2</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="文件处理"><a href="#文件处理" aria-hidden="true" class="header-anchor">#</a> 文件处理</h1> <p>本质：流文件的获取和转换。</p> <h2 id="常见场景"><a href="#常见场景" aria-hidden="true" class="header-anchor">#</a> 常见场景</h2> <ul><li>通过 input 上传</li> <li>文件拖拽上传</li> <li>文件在线预览</li> <li>文件</li> <li>第三方接口需要</li></ul> <h2 id="流"><a href="#流" aria-hidden="true" class="header-anchor">#</a> 流</h2> <p>一切能被读写的都是文件，流是读取文件的抽象。流（Stream）就是指像水流一样长长的一串东西，流只有一个特征是连续的。</p> <h3 id="为什么要有流"><a href="#为什么要有流" aria-hidden="true" class="header-anchor">#</a> 为什么要有流</h3> <p>假设没有流, 所有的数据都可以用二进制串来表示，这样 CPU 读取也不会慢。但是为什么要有流呢？
常见的需求比如播放视频的时候, 我们肯定是希望从硬盘(或者网络)读取一点, 播放一点, 一个视频 4GB, 要是全部载入内存才能播放, 好多人都看不成 1080p 的了.所以, 我们有充分的理由把这种读一点处理一点(以及相反的生成一点, 写入一点)的数据类型(或曰操作)抽象出来, 这就是流。</p> <p>流数据最小单位也是字节（byte)。常见的有字节流、文本流、图片流、音频流、视频流、数据流。</p> <ul><li>图片流就是用二进制流来表示图片。</li> <li>二进制流是指流动的是二进制数字序列。</li> <li>文本流是指流动的数据是以字符形式出现。</li></ul> <h2 id="上传"><a href="#上传" aria-hidden="true" class="header-anchor">#</a> 上传</h2> <p>前端进行 <strong>上传</strong> 的方式有很多种，我们会根据不同的需求选择不同方式实现上传的功能，下面是我总结的几种比较常用的上传方式，当然现在的很多组件库已经封装好这些工具方法，我们只需要调用就可以了，但有时候遇上问题又无从下手，还是要从新看一遍源码才行，所以以下都是实现上传比较原生的方式，简单栗子希望大家能够接受。</p> <ul><li>表单上传(包括 iframe、jquery使用)</li> <li>formData 上传</li> <li>拖拽上传</li> <li>粘贴上传</li> <li>大文件断点续传</li></ul> <h3 id="表单上传"><a href="#表单上传" aria-hidden="true" class="header-anchor">#</a> 表单上传</h3> <p>我们知道如果要用表单上传一个文件，有两点是必须设置的，一是需要把 <code>form</code> 标签的 <code>enctype</code> 设置为 <code>multipart/form-data</code> , 二是 <code>form</code> 标签的 <code>method</code> 必须为 <code>post</code> 方法。那么这个 <code>enctype</code> 代表的是什么？ <code>multipart/form-data</code> 又是什么意思呢？</p> <p><code>enctype</code> 属性规定了在发送到服务器之前应该如何对表单数据进行编码，默认情况下这个属性的值是： <code>application/x-www-form-urlencoded</code>,也就是对所有字符都会进行编码。而我们设置的 <code>mutipart/form-data</code> 就不会对字符编码。</p> <p>如图：
实际上，请求时表单设置的 <code>enctype = &quot;multipart/form-data&quot;</code> 会被识别成请求头(Request Headers)中的 <code>Content-type: multipart/form-data</code>，<code>multipart</code> 是指互联网上的混合资源，资源可以由多种元素组成，<code>form-data</code> 表示可以使用 <code>HTML Form</code> 和 <code>POST</code> 方法上传文件，而 <code>boundary</code> 表示分隔符，当我们要上传多个表单项时，就要使用 <code>boundary</code> 分割。</p> <p><img src="/Notebook/assets/img/http.1c428c7a.jpg" alt=""></p> <p>第一个栗子：这是一个非常原始的上传文件的方式，点击 <code>submit</code> 后页面会跳转到表单 <code>action</code> 指向的页面，这种方式是需要改进的，否则页面的其他数据就会丢失。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span>form id<span class="token operator">=</span><span class="token string">&quot;form2&quot;</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;http://localhost:8100/upload-form&quot;</span> enctype<span class="token operator">=</span><span class="token string">&quot;multipart/form-data&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Choose file to upload<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
    如果是多文件上传，input 添加 multiple 属性即可
    单文件：<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;f1&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;f1&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
    多文件：<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;f1&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;f1&quot;</span> multiple <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
    input 必须设置 name 属性，否则数据无法发送<span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;btn-0&quot;</span><span class="token operator">&gt;</span>上 传<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;but2&quot;</span><span class="token operator">&gt;</span>上传<span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
</code></pre></div><p>要解决刷新页面的问题，可以采用以下两种方式：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 第一种 用 ajaxSubmit 提交数据</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.but2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#form2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ajaxSubmit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">responseText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成果！'</span><span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>responseText<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 第二种</span>
  <span class="token comment">// 在 form 标签上添加 target 属性，值为 iframe 标签的 name值</span>
  <span class="token comment">// target 属性规定在何处打开 action URL，默认情况就是 _blank 在新的窗口打开，这里配置的是 iframe 的 name值，会在这个指定的 iframe 框架打开</span>
  <span class="token operator">&lt;</span>iframe id<span class="token operator">=</span><span class="token string">&quot;temp-iframe&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;temp-iframe&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;&quot;</span> style<span class="token operator">=</span><span class="token string">&quot;display:none;&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>iframe<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>form method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> target<span class="token operator">=</span><span class="token string">&quot;temp-iframe&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;http://localhost:8100/upload-form&quot;</span> enctype<span class="token operator">=</span><span class="token string">&quot;multipart/form-data&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Choose file to upload<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;f1&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;f1&quot;</span> multiple <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;btn-0&quot;</span><span class="token operator">&gt;</span>上 传<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
</code></pre></div><p>介绍一下这次上传的服务端，用的是 <strong>node js</strong> + <strong>fs</strong>  + <strong>koa</strong> 框架写的服务端</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 服务入口
 */</span>
  <span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> koaStatic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> koaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token string">'8100'</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> uploadHost <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/uploads/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaBody</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    formidable<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">//设置文件的默认保存目录，不设置则保存在系统临时目录下  os</span>
        uploadDir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../static/uploads'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    multipart<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// 支持文件上传</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//开启静态文件访问</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaStatic</span><span class="token punctuation">(</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../static'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//二次处理文件，修改名称</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/upload-form'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> files <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>f1<span class="token punctuation">;</span><span class="token comment">//得到上传文件的数组</span>
        <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            files <span class="token operator">=</span> <span class="token punctuation">[</span>files<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        files <span class="token operator">&amp;&amp;</span> files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
            <span class="token keyword">var</span> path <span class="token operator">=</span> item<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> fname <span class="token operator">=</span> item<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//原文件名称</span>
            <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path <span class="token operator">+</span> fname<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//得到扩展名</span>
                <span class="token keyword">var</span> extArr <span class="token operator">=</span> fname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> ext <span class="token operator">=</span> extArr<span class="token punctuation">[</span>extArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> nextPath <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> ext<span class="token punctuation">;</span>
                <span class="token comment">//重命名文件</span>
                fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> nextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>uploadHost <span class="token operator">+</span> nextPath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>nextPath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{
            &quot;fileUrl&quot;:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
  * http server
  */</span>
  <span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'demo1 server start ......   '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h4> <p>表单上传文件是比较原始的一种方式，但也是比较基础的，在这个基础上发展了其他更方便的方式实现上传，很多组件库封装的上传组件也是根据这些原理上传文件。</p> <h3 id="formdata-异步上传"><a href="#formdata-异步上传" aria-hidden="true" class="header-anchor">#</a> formData 异步上传</h3> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData" target="_blank" rel="noopener noreferrer">formData<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>一开始用于实现表单数据的序列化，能够将表单元素的 <code>name</code> 和 <code>value</code> 进行组合，减少表单元素的拼接上传；后来结合 <code>file</code> 对象用于异步请求上传文件。当我们上传的文件比较大的时候，会出现服务器超时的情况，所以我们一般都会考虑采用异步上传的方式，以下是利用构造 FormData 对象模拟表单上传。</p> <p>获取文件对象一般通过 <code>input</code> 标签就可以拿到，但这个样式不太美观，很多组件库封装的上传组件都有类似的功能拿到 <code>file</code> 对象</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//获得文件列表，注意这里不是数组，而是对象</span>
      <span class="token keyword">const</span> fileList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//构造FormData对象</span>
      <span class="token keyword">const</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//多文件上传需要遍历添加到 fromdata 对象</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>fileList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">f</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 原生使用 xhr</span>
      <span class="token comment">// const xhr = new XMLHttpRequest();   //创建对象</span>
      <span class="token comment">// xhr.open('POST', 'http://localhost:8100/upfile', true)</span>
      <span class="token comment">// //发送时  Content-Type默认就是: multipart/form-data; </span>
      <span class="token comment">// xhr.send(fd)</span>
      <span class="token comment">// xhr.onreadystatechange = function () {</span>
      <span class="token comment">//     console.log('state change', xhr.readyState);</span>
      <span class="token comment">//     if (this.readyState == 4 &amp;&amp; this.status == 200) {</span>
      <span class="token comment">//      var obj = JSON.parse(xhr.responseText);   //返回值</span>
      <span class="token comment">//       console.log(obj);</span>
      <span class="token comment">//       if (obj.fileUrl.length) {</span>
      <span class="token comment">//        alert('上传成功');</span>
      <span class="token comment">//       }</span>
      <span class="token comment">//     }</span>
      <span class="token comment">//  }</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>浏览器文件下载会自带进度显示，那我们文件上传也当然有对应的进度提醒，如何获取我们文件上传的进度呢？如果细心阅读过 <a href="https://www.npmjs.com/package/axios#request-config" target="_blank" rel="noopener noreferrer">axios<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 官方文档肯定知道,请求配置里有个 <code>onUploadProgress</code> 事件，就是这里我们能够实时的监听到文件上传的进度：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> progressSpan <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>firstElementChild
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onUploadProgress</span><span class="token punctuation">:</span> <span class="token parameter">progressEvent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> complete <span class="token operator">=</span> <span class="token punctuation">(</span>progressEvent<span class="token punctuation">.</span>loaded <span class="token operator">/</span> progressEvent<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span>
      progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> complete <span class="token operator">+</span> <span class="token string">'0px'</span>
      progressSpan<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> complete
      <span class="token keyword">if</span> <span class="token punctuation">(</span>complete <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进度条变色</span>
        progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 如果想要了解原生的 XMLHttpRequest2 进度条写法,可以参考下面栗子</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//创建对象</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回值</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//alert('上传成功');</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>onprogress <span class="token operator">=</span> updateProgress<span class="token punctuation">;</span> <span class="token comment">// 上传进度调用方法实现</span>
  <span class="token keyword">function</span> <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> completedPercent <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>loaded <span class="token operator">/</span> event<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> completedPercent <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">;</span>
      progressSpan<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> completedPercent
      <span class="token keyword">if</span> <span class="token punctuation">(</span>completedPercent <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进度条变色</span>
        progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已上传'</span><span class="token punctuation">,</span> completedPercent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//注意 send 一定要写在最下面，否则 onprogress 只会执行最后一次 也就是100%的时候</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送时  Content-Type默认就是: multipart/form-data;</span>
</code></pre></div><h4 id="总结-2"><a href="#总结-2" aria-hidden="true" class="header-anchor">#</a> 总结</h4> <p>如果是一次请求上传多个文件需要显示一个进度条，上面介绍的方法足以实现；如果是大文件分片上传多次请求的话，也是可以做到单进度提示，后面会详细介绍。</p> <h3 id="拖拽上传"><a href="#拖拽上传" aria-hidden="true" class="header-anchor">#</a> 拖拽上传</h3> <p>拖拽上传的场景我们也会经常遇到，在 HTML 5 之前，想要实现 Drag and Drop（拖拽/拖放）一般需要求助于 JQuery，现在我们能简单的对任意元素实现拖放功能。核心是理解原生的拖拽事件，可以简单划分为几个步骤：</p> <ul><li>定义一个允许拖放文件的区域 <code>div.drop-box</code> (如果是拖拽其他元素，是要设置 <code>draggable=&quot;true&quot;</code>，这里上传文件所以不需要)</li> <li>取消有关拖拽事件的默认行为，也就是 <code>e.preventDefault()</code></li> <li>为这个拖放区域添加拖拽样式</li> <li>在 <code>drop</code> 事件获取文件信息 <code>e.dataTransfer.files</code></li></ul> <p>先从一张图了解一下拖拽分别会触发哪些事件：</p> <ul><li>drag source: 是我们拖拽的源元素</li> <li>intermediate zone: 是拖拽过程可能经过的区域</li> <li>drop target: 是最终拖放的目标元素</li></ul> <p><img src="/Notebook/assets/img/dragEvent.92ff73ec.png" alt=""></p> <p><img src="/Notebook/assets/img/drag-start.ca38023e.png" alt=""> <img src="/Notebook/assets/img/drag-enter.c383a189.png" alt=""> <img src="/Notebook/assets/img/drop.26919dcb.png" alt=""> <img src="/Notebook/assets/img/drop-end.b6caaf2f.png" alt=""></p> <p>来看实际栗子：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 这个是我们的拖放区域</span>
  <span class="token keyword">const</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drop-box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//设置拖拽事件</span>
  <span class="token keyword">function</span> <span class="token function">openDropEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;dragover&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置进入拖放区域样式</span>
    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;dragenter&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'element dragenter'</span><span class="token punctuation">)</span>
      <span class="token comment">// 为什么不在 dragover 设置呢？因为触发太频繁了，Chrome 实测 1ms 左右触发；Firefox 大概是 300ms</span>
      box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hilight'</span><span class="token punctuation">)</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 设置离开拖放区域样式</span>
    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;dragleave&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'elemenet dragleave'</span><span class="token punctuation">)</span>
      box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hilight'</span><span class="token punctuation">)</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 鼠标松开释放文件到拖放区域</span>
    box<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;drop&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'element drop'</span><span class="token punctuation">)</span>
      box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hilight'</span><span class="token punctuation">)</span>
      <span class="token comment">//取消浏览器默认拖拽效果，否则浏览器会默认打开文件</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//获取拖拽中的文件对象</span>
      <span class="token keyword">const</span> fileList <span class="token operator">=</span> e<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">;</span>
      <span class="token comment">//用来获取文件的长度（其实是获得文件数量）</span>
      <span class="token keyword">const</span> len <span class="token operator">=</span> fileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fielist is array?'</span><span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>fileList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//检测是否是拖拽文件到页面的操作</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        box<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'over'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 因为是 FileList 对象 不能直接用 forEach</span>
      <span class="token comment">// 解决重复添加文件的处理</span>
      <span class="token keyword">let</span> files <span class="token operator">=</span> window<span class="token punctuation">.</span>willUploadFileList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>fileList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fileName <span class="token operator">=</span> item<span class="token punctuation">.</span>name
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>files<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> file<span class="token punctuation">.</span>name <span class="token operator">===</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> dropBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drop-box'</span><span class="token punctuation">)</span>
      dropBox<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
      files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fileName <span class="token operator">=</span> file<span class="token punctuation">.</span>name
      <span class="token keyword">const</span> divFileName <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
      divFileName<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'file-name'</span>
      divFileName<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> fileName
      dropBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>divFileName<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
       window<span class="token punctuation">.</span>willUploadFileList <span class="token operator">=</span> files
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="补充"><a href="#补充" aria-hidden="true" class="header-anchor">#</a> 补充</h4> <p>这篇博客有助于我们更好的认识拖拽事件，感兴趣的可以去看看：<a href="https://lotabout.me/2018/HTML-5-Drag-and-Drop/" target="_blank" rel="noopener noreferrer">https://lotabout.me/2018/HTML-5-Drag-and-Drop/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="粘贴上传"><a href="#粘贴上传" aria-hidden="true" class="header-anchor">#</a> 粘贴上传</h3> <p>核心是监听 <code>paste</code> 事件和获取粘贴板数据</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 粘贴上传</span>
  <span class="token keyword">const</span> editorBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'editor-box'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 监听粘贴事件</span>
  editorBox<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// IE浏览器只支持 windown.clipboardData获取粘贴板数据</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>clipboardData <span class="token operator">||</span> window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> data
    <span class="token keyword">const</span> fileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存储文件数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">&amp;&amp;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 检索剪切板items</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        fileList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getAsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    window<span class="token punctuation">.</span>willUploadFileList <span class="token operator">=</span> fileList<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">submitPasteUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">submitPasteUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> fileList <span class="token operator">=</span> window<span class="token punctuation">.</span>willUploadFileList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//构造FormData对象</span>
    Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>fileList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">f</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持多文件上传</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fileUrl<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
          img<span class="token punctuation">.</span>src <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fileUrl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          img<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100px'</span>
          <span class="token function">insertNodeToEditor</span><span class="token punctuation">(</span>editorBox<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上传成功'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//光标处插入 dom 节点</span>
  <span class="token keyword">function</span> <span class="token function">insertNodeToEditor</span><span class="token punctuation">(</span><span class="token parameter">editor<span class="token punctuation">,</span> ele</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//插入dom 节点</span>
    <span class="token keyword">let</span> range<span class="token punctuation">;</span><span class="token comment">//记录光标位置对象</span>
    <span class="token keyword">const</span> node <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>anchorNode<span class="token punctuation">;</span>
    <span class="token comment">// 这里判断是做是否有光标判断，因为弹出框默认是没有的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      range <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取光标起始位置</span>
      range<span class="token punctuation">.</span><span class="token function">insertNode</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在光标位置插入该对象</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      editor<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="总结-3"><a href="#总结-3" aria-hidden="true" class="header-anchor">#</a> 总结</h4> <p>粘贴上传的场景比较少，所以实际测试的栗子也不多，这里还存在两个问题，暂时没想到怎么解决：一是粘贴多个文件只能成功复制最后一个文件，也就是只有最后一个文件成功上传；二是 <code>windows</code> 系统不支持磁盘复制文件上传， <code>mac</code>系统是可以支持的</p> <h3 id="大文件断点续传"><a href="#大文件断点续传" aria-hidden="true" class="header-anchor">#</a> 大文件断点续传</h3> <p>上传的文件太大怎么处理呢？我们可以考虑将文件分片上传。</p> <p><strong>思路</strong> 是这样的： 选择上传一个 60+MB 的大文件，按每 10MB 进行分片，发送到服务器时携带一个标志(这里用的是时间戳，具体可以与后端协调)，服务端生成临时文件，在最后一个分片上传完成后，客户端发送一个上传结束请求合并文件的请求，服务端将所有文件分片按照标志合并成一个文件，最后清理临时文件</p> <p><img src="/Notebook/assets/img/slice-file.b46341e5.jpg" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> file
  <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 分片大小，可设置为 10 20 100</span>
    file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 获取文件对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择上传文件'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> chunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span> <span class="token comment">// 计算这个文件可以切成几块</span>
    <span class="token keyword">const</span> fileChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 文件分片后组成一个数组</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 文件唯一标识，用于最后合并文件</span>

    <span class="token comment">// File 对象继承了 Blob 的属性方法，而 Blob 它表示原始数据,也就是二进制数据</span>
    <span class="token comment">// 提供了对数据截取的方法 slice，所以可以直接使用此方法对文件进行分段</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断文件大小是否大于 约定分片的大小</span>
      <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token number">0</span>            <span class="token comment">// 开始分片</span>
      <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        end <span class="token operator">+=</span> chunkSize
        <span class="token keyword">const</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
        start <span class="token operator">+=</span> chunkSize
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blob<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span> <span class="token comment">//拆分结束</span>
        <span class="token punctuation">}</span>
        fileChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fileChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
</code></pre></div><p>文件对象：
<img src="/Notebook/assets/img/file-object.729de6b3.png" alt=""></p> <p>文件分片结果：</p> <p><img src="/Notebook/assets/img/file-slice-result.4a5bf103.png" alt=""></p> <p>接着是处理上传的逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> progressSpan <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>firstElementChild <span class="token comment">// 简单配一下进度条</span>
    progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'0'</span>
    progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 按顺序上传</span>
    <span class="token keyword">const</span> <span class="token function-variable function">upLoadInOrder</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//构造FormData对象</span>
        fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span> <span class="token comment">// 与后端协调分片需要传送过去的参数，一般是文件的标识id，分片长度，分片的序号、所占长度等等</span>
        fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> fileChunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> fileChunks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上传完成，发送合并请求'</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> formD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'merge'</span><span class="token punctuation">)</span>
          formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
          formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'chunks'</span><span class="token punctuation">,</span> fileChunks<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
          axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> formD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传完成！'</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
              <span class="token function-variable function">onUploadProgress</span><span class="token punctuation">:</span> <span class="token parameter">progressEvent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> complete <span class="token operator">=</span> <span class="token punctuation">(</span>progressEvent<span class="token punctuation">.</span>loaded <span class="token operator">/</span> progressEvent<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span>
                progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> complete <span class="token operator">+</span> <span class="token string">'%'</span>
                progressSpan<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> complete
                <span class="token keyword">if</span> <span class="token punctuation">(</span>complete <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 进度条变色</span>
                  progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token comment">// 不是必须的 可以在这里告知服务端我上传的片段信息</span>
              headers<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">'Content-Range'</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">*</span> chunkSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileChunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">+</span> i <span class="token operator">*</span> chunkSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'0'</span>
                progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span>
                i<span class="token operator">++</span>
                <span class="token function">upLoadInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token function">upLoadInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//绑定提交事件</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn-submit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> submitUpload<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这就是一个简单的文件分片上传的过程，但往往实际情况不会那么完美，如果上传分片的过程中网络中断，那之前上传的分片就会丢失，我们是不希望这种情况发生的，最好就是能够在上一次中断的地方继续上传文件，于是就有了断点续传这个概念。</p> <p>什么是断点续传呢？简单来讲就是上传文件过程出现线路中断，客户端再次上传时，能根据服务端返回的信息在中断的地方继续文件的上传，能够节省上传时间也提高了效率。</p> <p><img src="/Notebook/assets/img/slice-file-update.c4338c6a.png" alt=""></p> <p>判断文件中断上传的位置这里用的是 <code>localStorage</code> 保存上传分片成功的信息，在项目中，这个信息一般是由后端提供，前端只需要调用一个查询缓存的接口，获取当前文件在服务器上的缓存信息，返回已缓存文件的标识和大小，这个大小就是用来决定我们从文件哪里进行续传</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> saveChunkKey <span class="token operator">=</span> <span class="token string">'chunkUploaded'</span>


    <span class="token comment">//思路概括</span>
    <span class="token comment">//把大文件分成每10M 一块进行上传，发送到服务器同时携带一个标志 暂时用当前的时间戳 ，</span>
    <span class="token comment">//服务端生成临时文件，服务端接受一个文件结束的标志 ，然后将所有的文件进行合并成一个文件，清理临时文件。 返回结果（看情况）</span>
    <span class="token keyword">function</span> <span class="token function">submitUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">debugger</span>
        <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span><span class="token comment">//2m</span>

        <span class="token keyword">const</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> chunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span> <span class="token comment">// 计算这个文件可以切成几块</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">总共</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">个分片</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 文件唯一标识，用于最后合并文件</span>
        <span class="token keyword">const</span> fileChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">const</span> progressSpan <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>firstElementChild <span class="token comment">// 简单配一下进度条</span>
        progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'0'</span>
        progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择文件'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//拆分文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//拆分文件</span>
            <span class="token keyword">var</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                end <span class="token operator">+=</span> chunkSize<span class="token punctuation">;</span>
                <span class="token keyword">var</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                start <span class="token operator">+=</span> chunkSize<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>blob<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//拆分结束</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                fileChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            fileChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> uploadedInfo <span class="token operator">=</span> <span class="token function">getUploadedFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uploadedInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">const</span> <span class="token function-variable function">upLoadInOrder</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// const uploadedIndex = uploadedInfo.findIndex(up =&gt; up === true)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadedInfo<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 说明有分片缓存</span>
                i<span class="token operator">++</span>
                <span class="token function">upLoadInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//构造FormData对象</span>
            fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span> <span class="token comment">// 与后端协调分片需要传送过去的参数，一般是文件的标识id，分片长度，分片的序号、所占长度等等</span>
            fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'f1'</span><span class="token punctuation">,</span> fileChunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'上传完成，发送合并请求'</span><span class="token punctuation">)</span>
                <span class="token keyword">const</span> formD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'merge'</span><span class="token punctuation">)</span>
                formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
                formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'chunkCount'</span><span class="token punctuation">,</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                formD<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> formD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'上传完成！'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token function-variable function">onUploadProgress</span><span class="token punctuation">:</span> <span class="token parameter">progressEvent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> complete <span class="token operator">=</span> <span class="token punctuation">(</span>progressEvent<span class="token punctuation">.</span>loaded <span class="token operator">/</span> progressEvent<span class="token punctuation">.</span>total <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> complete <span class="token operator">+</span> <span class="token string">'%'</span>
                        progressSpan<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> complete
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>complete <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 进度条变色</span>
                            progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/upfile'</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sendChunkCount'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
                    <span class="token function">setUploadedToStorage</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                    i<span class="token operator">++</span>
                    <span class="token function">upLoadInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">upLoadInOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
        <span class="token comment">//获得本地缓存的数据</span>
    <span class="token keyword">function</span> <span class="token function">getUploadedFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>saveChunkKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;{}&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//写入缓存</span>
    <span class="token keyword">function</span> <span class="token function">setUploadedToStorage</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> uploaded <span class="token operator">=</span> <span class="token function">getUploadedFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        uploaded<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>saveChunkKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>uploaded<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="补充："><a href="#补充：" aria-hidden="true" class="header-anchor">#</a> 补充：</h4> <p>当我们进行断点续传时，一般会在<strong>请求头</strong>添加 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range" target="_blank" rel="noopener noreferrer">Range<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 如 <code>Range: byte=2000-4000</code>,告诉服务端我们要获取 2000byte 到 4000byte 的文件块数据；
而服务端在返回的<strong>响应头</strong>就会携带一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Range" target="_blank" rel="noopener noreferrer">Content-Range<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 如 <code>Content-Range: 2000-4000/67589</code>, 显示的是一个数据片段在整个文件中的位置</p> <h4 id="问题："><a href="#问题：" aria-hidden="true" class="header-anchor">#</a> 问题：</h4> <p>如果我们想要分片上传我们的大文件但又只想以一个进度条显示，请问要如何处理呢？ <code>onUploadProgress</code> 还是在这个地方处理</p> <h4 id="答案："><a href="#答案：" aria-hidden="true" class="header-anchor">#</a> 答案：</h4> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onUploadProgress</span><span class="token punctuation">:</span> <span class="token parameter">progressEvent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> complete <span class="token operator">=</span> <span class="token punctuation">(</span>progressEvent<span class="token punctuation">.</span>loaded <span class="token operator">/</span> file<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果有缓存 tempSize</span>
          <span class="token comment">// const complete = (progressEvent.loaded / (file.size - tempSize) * 100 | 0)</span>
          <span class="token comment">// 或者</span>
          <span class="token comment">// const complete = ((progressEvent.loaded + tempSize) / file.size * 100 | 0)</span>
          progressSpan<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> complete <span class="token operator">+</span> <span class="token string">'%'</span>
          progressSpan<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> complete
          <span class="token keyword">if</span> <span class="token punctuation">(</span>complete <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 进度条变色</span>
              progressSpan<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'green'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="总结："><a href="#总结：" aria-hidden="true" class="header-anchor">#</a> 总结：</h4> <p>断点续传的核心是对文件的分割和中断位置的获取</p> <h3 id="文件夹上传"><a href="#文件夹上传" aria-hidden="true" class="header-anchor">#</a> 文件夹上传</h3> <p>当需要上传文件夹时，需要在 input上添加<strong>webkitdirectory</strong>属性（仅支持谷歌浏览器），这样在选择的时候就能选择文件夹上传了。这里增加一点难度，将文件夹压缩打包后再上传，选用的库是 <strong>JSZip</strong></p> <p>这是我们即将上传的文件夹结构:
<img src="/Notebook/assets/img/file-folder.3464e172.jpg" alt=""></p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@change</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>zipFiles<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">multiple</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multiple<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">webkitdirectory</span>
  <span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在 @change 中获取到了文件夹中所有的文件对象 FileList</span>
  <span class="token function">zipFiles</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这是打印出来的文件列表，可以看出文件的层级被<strong>扁平化</strong>了，如何能还原出原来的文件夹呢？
<img src="/Notebook/assets/img/file-list.cfb93579.jpg" alt=""></p> <p><a href="https://stuk.github.io/jszip" target="_blank" rel="noopener noreferrer">JSZip<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供了两个关键的 API：</p> <ul><li>zip.file(name, data [,options]) 创建一个文件</li> <li>zip.folder(name) 创建一个新的文件夹</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> JSZip <span class="token keyword">from</span> <span class="token string">'jszip'</span>
  <span class="token function">zipFiles</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target
    <span class="token keyword">const</span> zip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>webkitRelativePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token comment">// 根据文件路径 生成目标文件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// abc/123.pdf</span>
        zip<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// abc/hahhaha/456.pdf</span>
        zip<span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// abc/hahhaha/aaaa/rollup-cjs.jpg</span>
        zip<span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// abc/hahhaha/bbb/hahahhab/rollup-umd.jpg</span>
        zip<span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>从中可以发现除了根节点外，folder的创建跟 path的长度相关，可以用一个递归去生成目标文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> JSZip <span class="token keyword">from</span> <span class="token string">'jszip'</span>
<span class="token comment">// 在 @change 中获取到了文件夹中所有的文件对象 FileList</span>
  <span class="token keyword">async</span> <span class="token function">zipFiles</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target
    <span class="token keyword">const</span> zip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>webkitRelativePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 非根节点</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">const</span> <span class="token function-variable function">deepPath</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 插进文件</span>
            obj<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            i<span class="token operator">++</span>
            <span class="token keyword">const</span> folder <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 创建文件夹</span>
            <span class="token function">deepPath</span><span class="token punctuation">(</span>folder<span class="token punctuation">,</span> path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">deepPath</span><span class="token punctuation">(</span>zip<span class="token punctuation">.</span><span class="token function">folder</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根节点</span>
        zip<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> files<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> arrPath <span class="token operator">=</span> files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>webkitRelativePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> zip<span class="token punctuation">.</span><span class="token function">generateAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'blob'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 创建file对象</span>
        <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arrPath<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.zip</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'zip'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'打包失败！'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="下载"><a href="#下载" aria-hidden="true" class="header-anchor">#</a> 下载</h2> <p>后端一般提供一个 <code>URL</code>，前端根据需求不同，实现客户端的保存下载。根据这个<code>URL</code>，前端处理下载的方式还可以细分几种，比较常用的有以下几种：</p> <ul><li>a 标签下载</li> <li>iframe 标签下载</li> <li>location.href 下载</li> <li>FileSaver 下载</li></ul> <h3 id="a标签下载"><a href="#a标签下载" aria-hidden="true" class="header-anchor">#</a> a标签下载</h3> <h4 id="步骤"><a href="#步骤" aria-hidden="true" class="header-anchor">#</a> 步骤</h4> <ul><li>拿到文件url</li> <li>创建 <code>a</code> 标签，并添加 <code>download</code> 属性</li> <li>点击即可下载</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">downloadByA</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 后端提供的文件 url</span>
  <span class="token keyword">const</span> alink <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
  alink<span class="token punctuation">.</span>href <span class="token operator">=</span> url
  alink<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment">// 设置文件名</span>
  alink<span class="token punctuation">.</span><span class="token function">cick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>虽然只有区区几段代码，但里面学习的东西还是有很多，如这个h5的新属性 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/a" target="_blank" rel="noopener noreferrer">download<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> , 能够解决如图片、文本文档、pdf等浏览器自动在线预览而不能下载的问题。但它并没有想象中那么神通广大，遇上跨域的 url,它就失效了。</p> <p>那么如何解决跨域中 <code>download</code> 失效的问题呢？官网给我们指明了方向：使用 <code>blob:URL</code> 和 <code>data:URL</code>。其实a标签的<code>href</code>还可以接受除了相对和绝对路径之外的其他形式Url，也就是下面我们说到的 <code>blob: URL</code> 和 <code>data: URL</code>，或许大家对这两个 URL 有点陌生，我们一步步学习它们</p> <h4 id="api解析"><a href="#api解析" aria-hidden="true" class="header-anchor">#</a> API解析</h4> <p><em>首先</em>，认识一下这个 <strong>blob:URL</strong>，blob:URL 是由浏览器内部通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL" target="_blank" rel="noopener noreferrer">URL.createObjectURL()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 生成</p> <div class="language-js extra-class"><pre class="language-js"><code>objectUrl <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// 这里的 object 参数只能是 File 或 Blob 对象</span>
</code></pre></div><p>官网的解释是说 <code>URL.createObjectURL()</code> 静态方法会创建一个 <code>DOMString</code>，其中包含一个表示参数中给出对象的 URL。我理解是这个 URL 指向的就是我们提供的 File 或 Blob 对象的资源。这个 URL 是有生命周期的，它和创建它的窗口中的 document 绑定。所以，需要注意在每次调用 createObjectURL() 方法后，当我们不再需要这些 URL 对象时，必须通过调用 URL.revokeObjectURL() 方法来释放这些对象.</p> <p>而 <strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/data_URIs" target="_blank" rel="noopener noreferrer">data:URL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong> 是一个包含内容编码的 URL , 可由 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader" target="_blank" rel="noopener noreferrer">fileReader.readAsDataURL(blob / file)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 获得。它由四个部分组成：前缀(data:)、指示数据类型的MIME类型、可选的base64标记、数据本身(如果是文本类型直接嵌入，如果是二进制数据则进行base64编码后嵌入)。</p> <div class="language-js extra-class"><pre class="language-js"><code>data<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>mediatype<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">;</span>base64<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>data<span class="token operator">&gt;</span>

<span class="token comment">// 图片类型的 data:URL 可以通过 canvas.toDataURL(&quot;image/&quot; + mime) 获得</span>

<span class="token comment">// 简单的 text/plain 类型数据</span>
data<span class="token punctuation">:</span><span class="token punctuation">,</span>Hello<span class="token operator">%</span><span class="token number">2</span>C<span class="token operator">%</span><span class="token number">20</span>World<span class="token operator">!</span>
或 base64 编码后版本：data<span class="token punctuation">:</span>text<span class="token operator">/</span>plain<span class="token punctuation">;</span>base64<span class="token punctuation">,</span>SGVsbG8sIFdvcmxkIQ<span class="token operator">%</span><span class="token number">3</span>D<span class="token operator">%</span><span class="token number">3</span>D

<span class="token comment">// 一个HTML文档源代码 &lt;h1&gt;Hello, World&lt;/h1&gt;</span>
data<span class="token punctuation">:</span>text<span class="token operator">/</span>html<span class="token punctuation">,</span><span class="token operator">%</span><span class="token number">3</span>Ch1<span class="token operator">%</span><span class="token number">3</span>EHello<span class="token operator">%</span><span class="token number">2</span>C<span class="token operator">%</span><span class="token number">20</span>World<span class="token operator">!</span><span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>Fh1<span class="token operator">%</span><span class="token number">3</span>E

</code></pre></div><p>⚠需要注意的是，blob:URL 是允许Blob对象用作图像，下载二进制数据链接等的URL源，但它只能在应用内部使用，是一种<strong>伪协议URL</strong>, URL的生命周期和创建它的窗口中的document绑定。data:URL是<strong>前缀为 data: 协议的URL</strong>，可以在浏览器上随意使用(blob:URL只是对浏览器存储在内存中或者磁盘上的Blob的一个简单引用)。</p> <p>举个栗子：下载一张来自网上的图片</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 图片来自网上一张可爱的小柯基 http://img.mp.itc.cn/upload/20170605/9dea8e0dd718472aa913dae6a1e2b94b_th.jpg</span>

<span class="token keyword">function</span> <span class="token function">downloadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://img.mp.itc.cn/upload/20170605/9dea8e0dd718472aa913dae6a1e2b94b_th.jpg'</span>
  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// CORS 策略，会存在跨域问题https://stackoverflow.com/questions/20424279/canvas-todataurl-securityerror</span>
  image<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;crossOrigin&quot;</span><span class="token punctuation">,</span> <span class="token string">'Anonymous'</span><span class="token punctuation">)</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获得 data:URL</span>
    <span class="token keyword">const</span> imageDataUrl <span class="token operator">=</span> <span class="token function">imageUrlToBase64</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token keyword">const</span> downloadUrlDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    downloadUrlDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> imageDataUrl<span class="token punctuation">)</span>
    <span class="token comment">// // 第二种方式 即将数据转为Blob，再将Blob生成BlobURL，使用a标签下载</span>
    <span class="token comment">// // 在第一种方式基础上获得 blob:URL</span>
    <span class="token comment">// const imageBlobData = dataUrlToBlob(imageDataUrl)</span>
    <span class="token comment">// console.log(imageBlobData);</span>
    <span class="token comment">// const imageBlobUrl = URL.createObjectURL(imageBlobData)</span>
    <span class="token comment">// downloadUrlDom.setAttribute('href', imageBlobUrl)</span>
    <span class="token comment">// 设置文件名，不一定要写死</span>
    downloadUrlDom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'download'</span><span class="token punctuation">,</span> <span class="token string">'cuteDog'</span><span class="token punctuation">)</span>
    <span class="token comment">// 兼容性判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'download'</span> <span class="token keyword">in</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 非IE下载</span>
    downloadUrlDom<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// IE10+下载 需要用第二种方式获取到 blob:URL</span>
    navigator<span class="token punctuation">.</span><span class="token function">msSaveBlob</span><span class="token punctuation">(</span>imageBlobUrl<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将图片url转换成 base64</span>
<span class="token comment">// 原理： 利用canvas.toDataURL的API转化成 data:URL</span>
<span class="token keyword">function</span> <span class="token function">imageUrlToBase64</span><span class="token punctuation">(</span><span class="token parameter">img</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> img<span class="token punctuation">.</span>width<span class="token punctuation">;</span>  
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> img<span class="token punctuation">.</span>height<span class="token punctuation">;</span>  
  <span class="token comment">// 返回一个 CanvasRenderingContext2D 对象，使用它可以绘制到 Canvas 元素中</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;2d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>width<span class="token punctuation">,</span> img<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向画布上面绘制图片</span>
  <span class="token keyword">const</span> mime <span class="token operator">=</span> img<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取图片的具体类型</span>
  <span class="token keyword">const</span> dataUrl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">&quot;image/&quot;</span> <span class="token operator">+</span> mime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最后利用返回一个包含图片展示的 data URI </span>
  <span class="token keyword">return</span> dataUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// data:URL 转 Blob数据</span>
<span class="token comment">// 其实就是利用 data:URL 最后一部分的编码数据进行转换</span>
<span class="token keyword">function</span> <span class="token function">dataUrlToBlob</span><span class="token punctuation">(</span><span class="token parameter">dataUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> dataUrl<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      mime <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/:(.*?);/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      bStr <span class="token operator">=</span> <span class="token function">atob</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      n <span class="token operator">=</span> bStr<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      unit8Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 以对象的方式或使用数组下标索引的方式引用数组中的元素</span>
    unit8Array<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> bStr<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回指定位置的字符的 Unicode 编码</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>unit8Array<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> mime <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

</code></pre></div><p>再举一个栗子，我们下载一个 pdf 文件(为什么选择 pdf 呢？因为这也是浏览器能够在线预览的文件类型之一，而 zip、docx、xslx等都能够直接通过 a 标签下载不会出现自动打开的问题。)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果后端返回的数据是一个banse64编码的文件，前端就需要进行一下转换</span>
<span class="token comment">// 或者在请求头上添加 responseType: 'blob', 这样处理起来会简单很多</span>
<span class="token comment">// 下面还是以 base64 格式文件进行处理</span>
<span class="token function">downloadPDF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将 base64 转换成 blob</span>
  <span class="token comment">// 后端能直接处理成 blob 就能省略这些了</span>
  <span class="token keyword">const</span> <span class="token function-variable function">base64ToBlob</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataUrl</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dataUrl<span class="token punctuation">)</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> dataUrl<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> mime <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/:(.*?);/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// 经过 base-64 编码的字符串进行解码</span>
    <span class="token keyword">const</span> bStr <span class="token operator">=</span> <span class="token function">atob</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> bStr<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> unit8Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 以对象的方式或使用数组下标索引的方式引用数组中的元素</span>
      unit8Array<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> bStr<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">//返回指定位置的字符的 Unicode 编码</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>unit8Array<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> mime <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> alink <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
  <span class="token comment">// 这里请求一个本地的 pdf 文件，用的 koa 框架写的一些简单服务，返回的 res.data 是一个进行 base64 编码的文件</span>
  axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8100/downloads/JavaScript.pdf'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/pdf'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dataUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:application/pdf;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token function">base64ToBlob</span><span class="token punctuation">(</span>dataUrl<span class="token punctuation">)</span>
    <span class="token comment">// 如果 res 是一个 blob 数据，直接跳到这一步即可</span>
    <span class="token comment">// 直接获取一个 blob:URL 进行下载操作</span>
    alink<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">,</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span>
    alink<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'download'</span><span class="token punctuation">,</span> <span class="token string">'JavaScript'</span><span class="token punctuation">)</span>
    alink<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="疑问"><a href="#疑问" aria-hidden="true" class="header-anchor">#</a> 疑问</h4> <p>或许会有人感到疑惑，如果 <code>data:URL</code> 就能够解决<strong>资源跨域</strong>的问题为什么还要继续用<code>blob:URL</code>呢？ 首先， <code>data:URL</code> 是一个包含内容编码的 URL, 如果编码数据过长，这个 URL 有可能会超过浏览器的限制而出现报错。其次，一般情况下，我们能够在请求时，设置 <code>responseType = blob</code>来获取我们需要的 <code>blob</code>格式的数据，在这种情况下转换成 <code>blob:URL</code>是比较简单方便的。</p> <h4 id="总结-4"><a href="#总结-4" aria-hidden="true" class="header-anchor">#</a> 总结</h4> <p>a标签下载的方式还是很通用的，如果出现在线打开的问题，可以采用转换 URL 的方式实现保存下载；而如果需要我们自定义下载进度，可以再考虑通过 <code>axios</code> 请求获取进度， 再配合 data:URL 或 blob:URL 下载。但缺点是它不兼容 IE 浏览器，后面我们会讲解如何在 IE 上保存下载。</p> <h4 id="补充资料："><a href="#补充资料：" aria-hidden="true" class="header-anchor">#</a> 补充资料：</h4> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLCanvasElement/toDataURL" target="_blank" rel="noopener noreferrer">canvas.toDataURL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowBase64/atob" target="_blank" rel="noopener noreferrer">atob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array" target="_blank" rel="noopener noreferrer">Uint8Array<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/charCodeAt" target="_blank" rel="noopener noreferrer">charCodeAt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/msSaveBlob" target="_blank" rel="noopener noreferrer">msSaveBlob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="location-href下载"><a href="#location-href下载" aria-hidden="true" class="header-anchor">#</a> location.href下载</h3> <p>location.href 这种下载方式基本不使用，语法很简单，但灵活性比较差</p> <div class="language-js extra-class"><pre class="language-js"><code>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'../downloads/cutegirl.jpg'</span>
</code></pre></div><p>它的缺点是最明显的，浏览器支持在线预览的图片、文本文档、pdf文件都会在线打开不会提示下载，不能像 <code>a</code> 标签的 <code>href</code> 那样接受其他形式的 <code>URL</code>, 所以现在都比较少用到这种方式处理下载</p> <h3 id="iframe下载"><a href="#iframe下载" aria-hidden="true" class="header-anchor">#</a> iframe下载</h3> <p><code>iframe</code> 使用相信很多小伙伴都有用过，我们在处理在线预览 <code>pdf</code> 或者嵌入其他框架时会用到。除此之外，其实它还可以用作文件的下载，使用上与 <code>a</code> 标签有点相似，都是通过创建一个标签后进行下载。它的优点是能够实现无刷新下载，体验感较好。但它的缺点也是明显的，我们没办法预测到文件什么时候启动下载或完成下载，添加到页面 <code>body</code>上的 <code>iframe</code> 标签也无法监听删除。</p> <p>小栗子：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 无闪现下载excel</span>
  <span class="token keyword">function</span> <span class="token function">handleDownIframe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 缺点是无法监听下载进度，无法剔除 iframe 标签</span>
    <span class="token comment">// 如果文件类型是 图片、文本文档类型也不能出现保存下载</span>
    <span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span>
    iframe<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span>
    iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'../downloads/helpFile.docx'</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="总结-5"><a href="#总结-5" aria-hidden="true" class="header-anchor">#</a> 总结</h4> <p>iframe 下载和 location.href 的缺点都是不能保存下载浏览器支持预览的文件，也不能通过转换 URL 来处理，同时 iframe 不像 a 标签可以通过点击事件触发下载，它必须添加到页面才能触发下载，我们无法确定什么时候可以去掉这个 iframe 标签。值得学习的是， iframe 能支持多次点击下载，文件下载互不影响；而 a 标签是需要等待服务器响应才能进行下载操作，如果多次点击下载，结果只有最后一个文件是真正下载成功的</p> <h3 id="filesaver-下载"><a href="#filesaver-下载" aria-hidden="true" class="header-anchor">#</a> FileSaver 下载</h3> <p>如果后端返回的是以文件流的格式，前端只需在请求头设置一个 <code>responseType = 'blob'</code>，再通过上面所讲的方法进行下载即可，那这里为什么还要另外开一个内容呢？其实是除了 <code>a</code> 标签外，还有一些兼容性更好的方式进行下载，接下来介绍一下 <a href="https://github.com/eligrey/FileSaver.js" target="_blank" rel="noopener noreferrer">FileSaver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个常用库。</p> <p>首先，为什么需要用到这个库？上面讲到 <code>a</code> 标签下载会有个浏览器兼容的问题，下面这个是 <code>a</code> 标签的 download 属性的兼容性截图，可以看到这里的 <strong>IE</strong> 是不支持的，而我们无法保证用户在使用过程是用的哪类浏览器，所以需要一个更好的方式避免出现因兼容问题而不能下载文件的现象。而 <strong>FileSaver</strong> 就是能够在不使用 <code>a</code> 标签的情况下或者没有原生支持 <code>saveAs()</code> 的浏览器上实现客户端保存文件以及在线生成文件保存的需求。</p> <h4 id="a-标签各属性"><a href="#a-标签各属性" aria-hidden="true" class="header-anchor">#</a> a 标签各属性</h4> <p><img src="/Notebook/assets/img/download-compatibility.e49888d1.png" alt=""></p> <p>接着我们来看看 <strong>FileSaver</strong> 支持的浏览器以及能够支持的文件数据大小是多少</p> <p><img src="/Notebook/assets/img/fileSaver-compatibility.aba6da92.png" alt=""></p> <p>可以看到，<strong>FileSaver</strong> 能够兼容大部分的浏览器，而且支持保存的文件大小也能满足一般的业务需求，如果处理的是 <strong>IE</strong> 浏览器，我们还可以用到 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/msSaveBlob" target="_blank" rel="noopener noreferrer">navigator.msSaveBlob()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个方法。来看看 <strong>FileSaver</strong> 的运用</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 采用 cdn 引入</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/FileSaver.js/2014-11-29/FileSaver.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

  <span class="token comment">// FileSaver 下载图片文件</span>
  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  image<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;crossOrigin&quot;</span><span class="token punctuation">,</span> <span class="token string">'Anonymous'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://img.mp.itc.cn/upload/20170605/9dea8e0dd718472aa913dae6a1e2b94b_th.jpg'</span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 继续沿用这几个数据转换的方法</span>
    <span class="token keyword">const</span> imageDataUrl <span class="token operator">=</span> <span class="token function">imageUrlToBase64</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> imageBlobData <span class="token operator">=</span> <span class="token function">dataUrlToBlob</span><span class="token punctuation">(</span>imageDataUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> downloadImageDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'download-image'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    downloadImageDom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">saveAs</span><span class="token punctuation">(</span>imageBlobData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// FileSaver 下载在线生成的文本文件</span>
  <span class="token keyword">const</span> txtDownloadDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'download-txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  txtDownloadDom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> textarea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'textarea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token function">generateFilename</span><span class="token punctuation">(</span><span class="token string">'textareaName'</span><span class="token punctuation">,</span> <span class="token string">'.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> textBlob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>textarea<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">&quot;text/plain;charset=utf-8&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">saveAs</span><span class="token punctuation">(</span>textBlob<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>上面都是比较简单的直接调用 <strong>api</strong> 实现下载的需求，但除了上面的简单的使用外，FileSaver 其实还有一个更强大的功能，那就是将在线生成的文档下载下来。
这个场景还是比较常见的，我们会遇到类似需要在线填写表格，并保存成excel格式下载下来，也就是常常说的<strong>报表下载</strong>。一般配合使用就是 <a href="https://github.com/SheetJS/sheetjs" target="_blank" rel="noopener noreferrer">js-xlsx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们再来看看在线生成 <code>excel</code> 并保存下载的 栗子:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 同样采用 cdn 引入</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/xlsx/0.14.1/xlsx.full.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

  <span class="token comment">// 下载excel文件</span>
  <span class="token keyword">const</span> excelDownloadDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'download-excel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  excelDownloadDom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意：XLSX.uitls.table_to_book( 放入的是table 的DOM 节点 )</span>
    <span class="token comment">// sheetjs.xlsx 即为导出表格的名字，可修改</span>
    <span class="token comment">// 创建一个工作簿对象</span>
    <span class="token keyword">const</span> wb <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">table_to_book</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#table-excel'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> wopts <span class="token operator">=</span> <span class="token punctuation">{</span> bookType<span class="token punctuation">:</span> <span class="token string">'xlsx'</span><span class="token punctuation">,</span> bookSST<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">'array'</span> <span class="token punctuation">}</span> <span class="token comment">// 输出配置</span>
    <span class="token keyword">const</span> wbout <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>wb<span class="token punctuation">,</span> wopts <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">saveAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>wbout<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'application/octet-stream'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'table-excel.xlsx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> console <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> wbout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>workbook</strong>：</p> <p><img src="/Notebook/assets/img/workbook-object.d7a9433b.png" alt=""></p> <p><code>table_to_book</code> 是官方提供给我们的工具函数，能够将我们提供的数据转换成一个 <code>workbook</code> 对象，如上面的栗子，我们将一个 <code>table-dom</code>上的数据转换成了一个 <code>workbook</code> 对象，通过打印信息可以看到，SheetNames里面保存了所有的sheet名字，然后Sheets则保存了每个sheet的具体内容（我们称之为Sheet Object）。每一个sheet是通过类似A1这样的键值保存每个单元格的内容，我们称之为单元格对象（Cell Object）</p> <p><code>XLSX.wirte</code> 就是将我们的 <code>workbook</code> 对象按照指定的文件类型输出</p> <p>想要继续研究这个 <code>js-xlsx</code> 库的的使用，小伙伴可以看看这几篇博客：</p> <p><a href="https://www.cnblogs.com/liuxianan/p/js-excel.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/liuxianan/p/js-excel.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://blog.csdn.net/tian_i/article/details/84327329" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/tian_i/article/details/84327329<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>如果需要研究 docx 文档保存的小伙伴，还可以看看这个：</p> <p><a href="https://www.cnblogs.com/liuxianan/p/js-excel.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/liuxianan/p/js-excel.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="文件下载"><a href="#文件下载" aria-hidden="true" class="header-anchor">#</a> 文件下载</h2> <p>拿图片为例子，存储有两种方式：</p> <p>可以将图片以独立的文件的形式存储再服务求的指定文件夹中，再将路径存入数据库字段中；
也可以将图片转换成二进制流，直接存储到数据库的 <code>Image</code> 类型字段中。</p> <p>那么在后端，可以直接返回该图片文件，也可以返回图片流。前端根据这两种方式进行处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>formCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 表单 code</span>
  <span class="token keyword">const</span> src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token constant">API</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token constant">API_FILE_DIR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">rest/pas/v1/naturalRes/dataform/download/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>formCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建隐藏的可下载链接;</span>
  <span class="token keyword">let</span> eleLink <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  eleLink<span class="token punctuation">.</span>download <span class="token operator">=</span> formName<span class="token punctuation">;</span>
  eleLink<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
  <span class="token comment">// 字符内容转变成blob地址</span>
  eleLink<span class="token punctuation">.</span>href <span class="token operator">=</span> src<span class="token punctuation">;</span>
  <span class="token comment">// 触发点击</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>eleLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// if (document.all) {</span>
  <span class="token comment">// 判断是否为 IE 浏览器</span>
  <span class="token comment">// eleLink.addEventListener('click', () =&gt; {</span>
  <span class="token comment">//   console.log('click');</span>
  <span class="token comment">// })</span>
  <span class="token comment">// eleLink.click(); // 这种方式无法触发下载</span>
  <span class="token comment">// } else</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>createEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> event <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">'MouseEvents'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eleLink<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 然后移除</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    eleLink<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDownLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">logAction</span><span class="token punctuation">(</span>logConfig<span class="token punctuation">.</span>NatureAnaEva<span class="token punctuation">.</span>xzcg<span class="token punctuation">,</span> <span class="token punctuation">{</span> targetObj<span class="token punctuation">:</span> formName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$Message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'无法生成 excel 表'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="文件在线生成"><a href="#文件在线生成" aria-hidden="true" class="header-anchor">#</a> 文件在线生成</h2> <h3 id="截图"><a href="#截图" aria-hidden="true" class="header-anchor">#</a> 截图</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 截图</span>
  <span class="token keyword">const</span> printCanvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">html2canvas</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    backgroundColor<span class="token punctuation">:</span> <span class="token string">'#ffffff'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dataURL <span class="token operator">=</span> printCanvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>dataURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待地图加载完成，arcgis 没提供加载完成通知</span>
</code></pre></div><h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="http://jartto.wang/2018/01/19/play-image-stream/" target="_blank" rel="noopener noreferrer">玩转图片流<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> —— 如果你认真的看完了文章，那么以后你对图片数据的处理就会顺畅很多。</li> <li><a href="https://www.zhihu.com/question/27996269" target="_blank" rel="noopener noreferrer">如何理解编程语言中「流」（stream）的概念？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> —— 流是什么，为什么要有流，能够从中探出一二。</li> <li><a href="https://segmentfault.com/a/1190000018234223" target="_blank" rel="noopener noreferrer">前端实现批量导出图片并打包压缩功能<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/2/2021, 1:24:26 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Notebook/frontend-web/security.html" class="prev">
          前端安全
        </a></span> <span class="next"><a href="/Notebook/frontend-web/interview.html">
          常见问题 1
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Notebook/assets/js/app.fae3116e.js" defer></script><script src="/Notebook/assets/js/3.8a90166b.js" defer></script><script src="/Notebook/assets/js/5.01244a1f.js" defer></script>
  </body>
</html>
